\documentclass[../main.tex]{subfiles}
\section{Examples}

\subsection{One provider}

Assume that there is only one provider, such that $N_{\mathcal{A}}(1) = \emptyset$. The provider's constraint, at each $t$, reduces to,

\begin{equation}
    X_t = \sum_{j \in \emptyset} Y_t^{(i, j)} = 0
\end{equation}

This implies that the providers needs to set $p_t$ such that,

\begin{equation}
    N \cdot( b + a\cdot p_t) = 0
\end{equation}


This intuitively implies that, given no outside option for the provider, the supply needs to be put constant at the prosumers' demand. If $e_t > 0$, the prosumers' endowment is not sufficient to cover the demand, then the production $S_t > 0$. Otherwise, if $e_t < 0$, $S_t = 0$ (i.e. there will be excess electricity which will be thrown away).

\subsection{Two providers}

Consider now the case of two providers drawn below.

\vspace{5mm}
\begin{minipage}{.5\textwidth}
    \resizebox{\textwidth}{!}{\input{sections/diagrams/two.tikz}}
\end{minipage}
\begin{minipage}{.45\textwidth}
    \begin{equation*}
        \matr{A} = \begin{pmatrix}
            0 & 1 \\
            1 & 0
        \end{pmatrix}
    \end{equation*}
\end{minipage}
\vspace{5mm}

Using the definition, we can compute the shadow price by,

\begin{equation}
    \begin{split}
        -\lambda_{1, t} = P^{(1, 2)}_t + Y^{(1, 2)}_t \cdot \frac{\partial P^{(1, 2)}}{\partial Y^{(1, 2)}}_t = \lambda_{2, t}
    \end{split}
\end{equation}

Using equation the bargaining solution (\ref{bargaining_solution}) we obtain the trading price,

\begin{equation}
    P^{(1, 2)}_t = \frac{X_{1, t} \cdot p_{1, t} - X_{2, t} \cdot p_{2, t}}{2 \cdot Y^{(1, 2)}_t}
\end{equation}

Note that the partial derivative of this trading price implies that,

\begin{equation}
    \begin{split}
        \frac{\partial P^{(1, 2)}}{\partial Y^{(1, 2)}}_t &= - \frac{P^{(1, 2)}_t}{Y^{(1, 2)}_t} \\
        \implies \lambda_{1, t} &= \lambda_{2, t} = 0
    \end{split}
\end{equation}

Given the null shadow price, to satisfy the constraint providers need to set prices such that, for every $t$,

\begin{equation}
    \begin{split}
        X_{1, t+1} &= - X_{2, t+1} \\
        N_1 \cdot \left( b_1 + a_1 \cdot p_{1, t} \right) &= - N_2 \cdot \left( b_2 + a_2 \cdot p_{2, t} \right)
    \end{split}
\end{equation}



\subsection{Star}

A more interesting example is that of the star graph, namely each provider has as a neighbor provider 1. Assume there are 4 providers/markets as below.

\vspace{5mm}
\begin{minipage}{.5\textwidth}
    \resizebox{\textwidth}{!}{\input{sections/diagrams/star.tikz}}
\end{minipage}
\begin{minipage}{.5\textwidth}
    \begin{equation*}
        \begin{split}
            \matr{A} &= \begin{pmatrix}
                0 & 1 & 1 & 1 \\
                1 & 0 & 0 & 0 \\
                1 & 0 & 0 & 0 \\
                1 & 0 & 0 & 0
            \end{pmatrix} \\
            \vspace{5mm} \\
            E &= \set{(1, 2), (1, 3), (1, 4)} \\
            \vspace{5mm} \\
            \matr{G} &= \begin{pmatrix}
                0 & 1 & 1 \\
                1 & 0 & 1 \\
                1 & 1 & 0
            \end{pmatrix}
        \end{split}
    \end{equation*}
\end{minipage}
\vspace{5mm}

Given the associated line graph, the matrix that determines the bargaining relations is,

\begin{equation}
    (2\matr{I} + \matr{G})^{-1} = \matr{I} - \frac{1}{4} \iota \iota^T
\end{equation}

hence the price vector and its Jacobian are,

\begin{equation}
    \begin{split}
        P(\Y_t) &=  \left(\matr{I} - \frac{1}{4} \iota \iota^T \right)  (\Delta_t  \oslash \Y_t) \\
        &= \Delta_t  \oslash \Y_t - \frac{\sum_{e \in E}\Delta^e_t / \Y^e_t }{4} \iota
    \end{split}
\end{equation}

\begin{equation}
    \begin{split}
        \mathbb{J}\{P\}(\Y_t) &= \left(\frac{1}{4} \iota \iota^T- \matr{I}  \right) \diag (\Delta_t  \oslash \Y^2_t) \\
        &= \frac{1}{4} \iota \Delta_t  \oslash \Y^2_t - \diag (\Delta_t  \oslash \Y^2_t) \\
        \\
        &= \frac{1}{4} \begin{pmatrix}
            -3 \frac{\Delta}{Y^2}^{(1, 2)} & \frac{\Delta}{Y^2}^{(1, 3)}     & \frac{\Delta}{Y^2}^{(1, 4)}     \\
            \frac{\Delta}{Y^2}^{(1, 2)}    & -3  \frac{\Delta}{Y^2}^{(1, 3)} & \frac{\Delta}{Y^2}^{(1, 4)}     \\
            \frac{\Delta}{Y^2}^{(1, 2)}    & \frac{\Delta}{Y^2}^{(1, 3)}     & -3  \frac{\Delta}{Y^2}^{(1, 4)} \\
        \end{pmatrix}
    \end{split}
\end{equation}

We can use the Jacobian to find the shadow price of the bargaining faced by agent 1,

\begin{equation}
    \begin{split}
        - \lambda_{1, t} &= P^{(1, 2)} - 3\cdot \frac{\Delta}{Y}^{(1, 2)} + \frac{\Delta}{Y}^{(1, 3)} + \frac{\Delta}{Y}^{(1, 4)} \\
        &= \frac{3}{4} \cdot \frac{\Delta}{Y}^{(1, 2)} - \frac{\Delta}{Y}^{(1, 3)} - \frac{\Delta}{Y}^{(1, 4)}  - 3\cdot \frac{\Delta}{Y}^{(1, 2)} + \frac{\Delta}{Y}^{(1, 3)} + \frac{\Delta}{Y}^{(1, 4)} = 0
    \end{split}
\end{equation}

\subsection{Star + Path}


\vspace{5mm}
\begin{minipage}{.5\textwidth}
    \resizebox{\textwidth}{!}{\input{sections/diagrams/starpath.tikz}}
\end{minipage}
\begin{minipage}{.5\textwidth}
    \begin{equation*}
        \begin{split}
            \matr{A} &= \begin{pmatrix}
                0 & 1 & 1 & 1 \\
                1 & 0 & 1 & 0 \\
                1 & 1 & 0 & 0 \\
                1 & 0 & 0 & 0
            \end{pmatrix} \\
            E &= \set{(1, 2), (1, 3), (1, 4), (2, 3)} \\
            \matr{G} &= \begin{pmatrix}
                0 & 1 & 1 & 1 \\
                1 & 0 & 1 & 1 \\
                1 & 1 & 0 & 0 \\
                1 & 1 & 0 & 0
            \end{pmatrix}
        \end{split}
    \end{equation*}
\end{minipage}
\vspace{5mm}


\begin{equation}
    (2\matr{I} + \matr{G})^{-1} =\matr{I} + \frac{1}{2} \begin{pmatrix}
        0  & 0  & -1 & -1 \\
        0  & 0  & -1 & -1 \\
        -1 & -1 & 0  & 1  \\
        -1 & -1 & 1  & 0
    \end{pmatrix}
\end{equation}

such that, letting $z^{(i, j)}_t \coloneqq \frac{\Delta X}{Y}^{(i, j)}_t$ and $\partial z_t^{(i, j)} \coloneqq \frac{\Delta X}{Y^2}^{(i, j)}_t$

\begin{equation}
    P(\Y_t) = \Delta_t  \oslash \Y_t - \frac{1}{2}
    \begin{pmatrix}
        - z_t^{(1, 4)} - z_t^{(2, 3)}                \\
        - z_t^{(1, 4)} - z_t^{(2, 3)}                \\
        - z_t^{(1, 2)} - z_t^{(1, 3)} + z_t^{(2, 3)} \\
        - z_t^{(1, 2)} - z_t^{(1, 3)} + z_t^{(1, 4)}
    \end{pmatrix} = \begin{pmatrix}
        z_t^{(1, 2)} - \frac{z_t^{(1, 4)} + z_t^{(2, 3)}}{2}                \\
        z_t^{(1, 3)} - \frac{z_t^{(1, 4)} + z_t^{(2, 3)}}{2}                \\
        z_t^{(1, 4)} + \frac{z_t^{(2, 3)} - z_t^{(1, 2)} - z_t^{(1, 3)}}{2} \\
        z_t^{(2, 3)} + \frac{z_t^{(1, 4)} - z_t^{(1, 2)} - z_t^{(1, 3)}}{2}
    \end{pmatrix}
\end{equation}

\begin{equation}
    \begin{split}
        \mathbb{J}\{P\}(\Y_t) &= \left[\matr{I} + \frac{1}{2} \begin{pmatrix}
                0  & 0  & -1 & -1 \\
                0  & 0  & -1 & -1 \\
                -1 & -1 & 0  & 1  \\
                -1 & -1 & 1  & 0
            \end{pmatrix} \right] \diag (\Delta_t  \oslash \Y^2_t) \\
    \end{split}
\end{equation}