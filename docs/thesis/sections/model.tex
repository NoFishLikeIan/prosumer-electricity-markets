\documentclass[../thesis.tex]{subfiles}
\section{Model}

\subsection{Notation introduction}

The model rests on two sources of friction. First, all agents are assumed to be boundedly rational. They do not know the workings of the market but have beliefs over price formations mechanisms and act consistently with them. Second, agents acting in cross-border markets interact on a graph structure. Before describing the model, it is then useful to introduce some notation.

\subsubsection{Beliefs}

To denote beliefs over some future variable $x_{t+1}$ I will use $\B[x_{t+1}]$. If beliefs are based on information up to time $t$, I will use $\B_t[x_{t+1}]$

\subsubsection{Graphs}

Graphs are a set of vertices and a set of edges, $\mathcal{A} = (V, E)$, and interactions can happen between markets only if they share an edge, $(i, j) \in E$. Furthermore, let the neighbors of a node be the set,

\begin{equation}
  N_{\mathcal{A}}(i) \coloneqq \set{ \ j \in V: \ (i, j) \in E \ }.
\end{equation}

% FIXME: Remove outside option

As cross-border markets interactions happen between edges, I will simplify the solution by relying on the notion of a directed line graph, $L(\mathcal{A})$, associated with the original graph, with adjacency matrix $\G \in \R^{\abs{E}\times \abs{E}}$. $L(\mathcal{A})$ can be constructed by mapping each edge of $\mathcal{A}$ to a vertex of $L(\mathcal{A})$ and drawing an edge between two nodes of $L(\mathcal{A})$ if the two share a node in the original graph (e.g. $(1, 2)$ and $(2, 7)$ would share an edge because they both share the node $2$ in $\mathcal{A}$). Finally, I give a positive sign to the edge if the ``outside option'' is that of the first entry and negative if is that of the second entry (e.g. in our prior example, the edge between $(1, 2)$ and $(2, 7)$ has sign $-1$ because $(2, 7)$ is the outside option of $2$ which is the second entry in $(1, 2)$). For example, consider an arbitrary long sequential graph,

\begin{figure}[H]
  \centering
  \input{sections/diagrams/linemodel.tikz}
\end{figure}

Such a graph has an adjacency matrix of size $n$,

\begin{equation}
  \matr{A} =
  \begin{pmatrix}
    {0} & {1} & {0} & {}       & {}  & {}  \\
    {1} & {0} & {1} & {}       & {}  & {}  \\
    {0} & {1} & {0} & {}       & {}  & {}  \\
    {}  & {}  & {}  & {\ddots} & {}  & {}  \\
    {}  & {}  & {}  & {}       & {0} & {1} \\
    {}  & {}  & {}  & {}       & {1} & {0}
  \end{pmatrix}
\end{equation}

Now to construct the corresponding line graph consider the sequential graph node $(i, i+1)$. The adjacency matrix of the line graph will have then entry $-1$ with the edge $(i+1, i+2)$ since it represents the outside option of the second element and, likewise, $-1$ with the edge $(i-1, i)$. Hence the adjacency matrix $\G,$ is the $(n-1) \times (n-1)$ matrix,

\begin{equation}
  \G =
  \begin{pmatrix}
    {0}  & {-1} & {0}  & {}       & {}   & {}   \\
    {-1} & {0}  & {-1} & {}       & {}   & {}   \\
    {0}  & {-1} & {0}  & {}       & {}   & {}   \\
    {}   & {}   & {}   & {\ddots} & {}   & {}   \\
    {}   & {}   & {}   & {}       & {0}  & {-1} \\
    {}   & {}   & {}   & {}       & {-1} & {0}
  \end{pmatrix}
\end{equation}

\begin{figure}[H]
  \centering
  \input{sections/diagrams/lineassocmodel.tikz}
\end{figure}

\subsection{Model introduction}

\begin{figure}[H]
  \centering
  \input{sections/diagrams/timing.tikz}
  \caption{Regional wholesale electricity market}
  \label{tikz:wholesale}
\end{figure}

The model (see Figure \ref{tikz:wholesale}) is composed of two market types (wholesale and cross-border) and three agent types (prosumers, providers, and producers). Each regional wholesale market contains $M$ homogenous prosumers, with perfectly inelastic demand, and $N$ heterogenous producers, who compete locally in quantity. The monopolist provider sets the local wholesale price, at which it sells to prosumers and buys from producers. In case of excess demand (supply) in the wholesale market, the provider acquires (sells) electricity in the cross-border market. Such a market is assumed to function via bilateral trading in a network between providers. Possibility of trading is contingent on the presence of an edge between two regional markets.

\subsection{Prosumers}

Prosumers are endowed an electricity quantity from renewable energy and have a constant electricity demand. This is modelled by assuming that an individual prosumer's demand can be in a high state ($\overline{e}$) or a low state ($\underline{e}$). That implies there is a ``representative prosumer'' per region with a given constant demand.

\subsection{Producers}

Electricity producers operate power plants and can generate electricity by ramping up or down production at a certain cost and with a one period delay. Electricity is then sold on the local market at a price $p$, set by electricity providers, and costs $k$ to maintain at a given production level $s$. Furthermore, they are naive about the price formation mechanism and assume prices to be constant, $\B \left[p_{t+1}\right] = p_{t}$,  hence independent of their production decisions. Let $c(s, r)$ be the cost of ramping up or turning down production next period by $r$ when currently at production level $s$. I assume $r$ is bounded between two values $\underline{r}(s_t)$ and $\overline{r}(s_t)$. This setup leads to the following optimization problem,

\begin{equation} \label{bellman_prod}
  \begin{split}
    V(s_t, p_t) &= \max_{r_t \in [\underline{r}(s_t), \overline{r}(s_t)]} \left\{ s_t \  (p_t - k) - c(s_t, r_t) \  r_t + \beta \  V(s_{t+1}, p_{t+1}) \right\} \\
    \text{ such that } s_{t+1} &= s_t + r_t \text{ with } s_t \geq 0 \text{ given } s_0 \\
    \text{ and } p_{t+1} &= p_t.
  \end{split}
\end{equation}

This optimization problem (see \ref{a:producer_optimization}) determines $r$ as a function of $s$ and $p$. In particular, $r$ is such that the marginal costs and marginal benefits of ramping up production are the same. The former are given by

\begin{equation*}
  mc(r; s_t, p_t) \coloneqq r \ \frac{\partial c}{\partial r}(s_t, r)  + c(s_t, r).
\end{equation*}

The producer by ramping up production pays $c(s_t, r)$ and increases the costs of ramping up by $r \ \frac{\partial c}{\partial r}(s_t, r)$. The latter are,

\begin{equation*}
  mb(r; s_t, p_t)  \coloneqq \beta \ \left[p_t - k + \left(\frac{\partial c}{\partial r}(s_t + r, r) - \frac{\partial c}{\partial s_t}(s_t + r, r)\right) \ r + c(s_t + r, r) \right],
\end{equation*}

which can be broken up into the price the producer believes they can get for the new production, $\B[p_{t+1}] - k = p_t - k$, the avoided marginal cost tomorrow of having increased production today instead, $r \ \frac{\partial c}{\partial r}(s_t + r, r) + c(s_t + r, r)$, and finally the increased marginal cost brought about by a higher level of production $\frac{\partial c}{\partial s_t}(s_t + r, r)$. Hence, in equilibrium $r$ is such that,

\begin{equation} \label{raw_policy_producer}
  mc(r; s_t, p_t) = mb(r; s_t, p_t).
\end{equation}

\iffalse % TODO: Add quadratic?

  To build some intuition over $r$, consider a simple quadratic cost function $c(s, r) = r$ (see Figure \ref{fig:quadcosts}). This function allows us to explicitly derive,

  \begin{equation}
    \begin{split}
      mc(r; s_t, p_t) &= 2r \\
      mb(r; s_t, p_t) &= p_t - k + 2r
    \end{split}
  \end{equation}

  such that,

  \begin{equation}
    r(s_t, p_t) = \frac{\beta}{2 (1 - \beta)}  \left(p_t - k \right).
  \end{equation}

  \begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{\plotpath/quadcosts.pdf}
    \caption{Quadratic cost function and an instance of solution}
    \label{fig:quadcosts}
  \end{figure}

\fi

% FIXME: Should I remove softplus and go piecewise?
Clearly, the ramp-up policy function will depend entirely on the choice of the marginal cost function, $c(s, r)$. Intuitively ramping down should have no costs, namely $c(s, r) = 0$ if $r < 0$, and should have increasing marginal costs both in scale of supply, $\partial c / \partial s > 0$, and in ramp-up level, $\partial c / \partial r > 0$. A differentiable function with (asymptotically) this feature is,

\begin{equation}
  c(s, r; c_1) \coloneqq \frac{1}{c_1} \ \log \left( 1 + \exp(c_1 \ s \ r) \right).
\end{equation}

Notice that $c(s, r; c_1) \xrightarrow{} \max \{ 0, s \ r \}$ as $c_1 \xrightarrow{}\infty$. In the limit $c_1 \xrightarrow{}\infty$, we can determine the policy function $r(s_t, p_t)$ analytically (see \ref{a:limiting}). This ``asymptotic'' policy function is continuous everywhere but fails to be differentiable in two points. The first trivial interval to consider is that where $p_t < k$. Here producers make a loss at each unit sold, or in terms of the first order condition $mc(r; s_t, p_t) > mb(r; s_t, p_t)$. They will then try and reduce production as much as possible, namely \begin{equation*} r(s_t, p_t) = \underline{r}(s_t). \end{equation*} The second interval is that where current electricity production is too low, namely $s_t < \frac{\beta}{1- \beta} \sqrt{p_t - k}$, which implies $mc(r; s_t, p_t) < mb(r; s_t, p_t)$. In this case, ramp-up will be as high as possible $r(s_t, p_t) = \overline{r}(s_t)$. Finally, the non-trivial case is that of the remaining interval where $mc(r; s_t, p_t) = mb(r; s_t, p_t)$. As shown in Appendix (\ref{a:limiting}),

\begin{equation} \label{rpolicy}
  r(s_t, p_t) =
  \frac{1 - \beta}{\beta} \ s_t - \sqrt{ \left(\frac{1 - \beta}{\beta} \ s_t \right)^2 - \ \left(p_t - k\right) }.
\end{equation}

This equation has a few intuitive properties. First of all, there is no ramp-up if there is no unit profit, that is $r(s_t, p_t) = 0$ if $p_t - k = 0$. Second, ramp-up increases in $p_t$. The function is plotted in Figure $\ref{fig:r}$, where I choose $\underline{r}(s) = - \delta s$ with $\delta \in (0, 1)$ and $\overline{r}(s) = \sqrt{p-k}$.

\begin{figure}[H]
  \centering
  \includegraphics[width=\textwidth]{\plotpath/rfunction.pdf}
  \caption{Ramp-up function}
  \label{fig:r}
\end{figure}

\subsubsection{Local demand}

Given any ramp-up policy function $r(s, p)$, it is possible to find the \textit{excess} demand of electricity in the local market, that is, the electricity demanded in the local market by local prosumers that it is not satisfied by local producers and has to then be acquired in the cross-border market. First, let $R_t$ be the aggregated ramp-up function,

\begin{equation}
  R(p_t, s_{1, t}, \ldots, s_{N, t}) \coloneqq \sum^N_{i = 1} r(s_{i, t}, p_t)
\end{equation}

Assuming that the local market is composed of $N$ producers and $M$ prosumers, the aggregate supply of electricity at time $t$, can be written as,

\begin{equation}
  \begin{split}
    \sum^N_{i = 1} s_{i, t+1} &= \sum^N_{i = 1} \left( s_{i, t} +  r(s_{i, t}, p_t) \right)\\
    S_{t+1} &= S_t + R_t
  \end{split}
\end{equation}

The electricity demanded by $M$ prosumers is determined by $e_t$ and it is assumed to be completely inelastic, namely prosumers will buy electricity at any price from providers or directly from producers. Hence the excess electricity demand at time $t$ is simply the difference between the demand and the supply,

\begin{equation} \label{x_inst}
  X_{t} = M e_{t} - S_{t}
\end{equation}

Note that if $S_t > M e_t$, there is an excess supply ($X_t < 0$) of electricity in the local market that the local provider can use to sell abroad. Given equation (\ref{x_inst}), we obtain the evolution of the process $X_t$ (see \ref{a:ev_demand}),

\begin{equation} \label{x_true}
  X_{t+1} = X_t + M \left(e_{t+1} - e_t \right) -  R_t.
\end{equation}

\subsection{Providers}

\begin{figure}[H]
  \centering
  \input{sections/diagrams/overview.tikz}
  \caption{An instance of the cross-border electricity market}
  \label{tikz:cb}
\end{figure}


% FIXME: This paragraph

Electricity providers are monopolists in their own local market and are indexed, as is their local market, by $i$. They set the local price $p_{i, t}$ at which they sell (purchase) the excess demand (supply) of electricity in the local market $X_{i, t}$. On the one hand, if there is excess demand in the market, $X_{i, t} > 0$, providers sell electricity to prosumers at price $p_{i, t}$. On the other hand, if there is excess supply, $X_{i, t} < 0$, they buy electricity off of prosumers and producers at price $p_{i, t}$. The excess demand (supply) is satisfied (sold) by trading with other providers in the network. Hence, providers trade electricity $Y^{(i, j)}$, at a bargained price $P^{(i, j)}$, with neighboring providers. $Y^{(i, j)} > 0$ if $i$ is buying from $j$ and the other way around for $Y^{(i, j)} < 0$. This also implies that $Y^{(i, j)} = -Y^{(j, i)}$. Hence, within the model, electricity providers have the role of market makers. The instantaneous payoff of provider $i$ is then,

\begin{equation}
  \Pi_i(p_{i, t}, \Y_{i, t}) = p_{i, t} \  X_{i, t}(p_{i, t-1}) - \sum_{j \in N_{\mathcal{A}}(i)} Y_t^{(i, j)} \  P_t^{(i, j)},
\end{equation}

where $p_{i, t} \in \R$ and

\begin{equation}
  \begin{split}
    \Y_{i, t} &\in \R^{\abs{N_{\mathcal{A}}(i)}}, \hspace{5mm}\Y_{i, t} = \begin{pmatrix}
      Y^{(i, 1)}_t \\
      Y^{(i, 2)}_t \\
      \vdots
    \end{pmatrix}
  \end{split}
\end{equation}

is a vector of traded quantities with the provider's neighbors. Furthermore, each period the optimization is subject to \begin{equation*}X_{i, t}(p_{i, t-1}) \leq  \sum_{j \in N_{\mathcal{A}}(i)} Y_t^{(i, j)}. \end{equation*}
This condition requires the provider to always match the quantity demanded in the local market by trading with its neighbors. Note that this implies that electricity across the network flows always towards places of scarcity but in doing so it disrupts the pricing across the network. In this way, electricity prices signal both scarcity and bargaining power within the network.

The provider's optimization is then an intertemporal problem that depends on the state $X_{i, t}$ which follows the evolution laid down in equation (\ref{x_true}). The provider is assumed to make two simplifying assumptions on this evolution. First, at time $t$, they assume $\B_{i, t}[e_{i, t+1}] = e_{i, t}$. This assumption is a good approximation in the case of a very persistent process $e_{i, t}$. Second, I assume the provider does not know the ramp-up function of producers in the local market, $r(s_{i, t}, p_{i, t})$, hence they approximate the aggregate ramp-up function by a linear adaptive rule, proportional to the price, namely

\begin{equation*}
  \B_{i, t} \left[R_{i, t}(p, S) \right] = \alpha_{i, t} + \gamma_{i, t} \  p + \eta_{i, t} \ S.
\end{equation*}


For now, assume every pairwise price on the network, $P^{(i, j)}$, is determined only by the vector of traded quantities, $\Y$. Given this setup we can specify the optimization problem of the provider. Suppressing $i$ for convenience (i.e. $Y^j \coloneqq Y^{(i, j)}$), the Bellman  equation can be written as,

\begin{equation*}
  V(X_t, S_t) = \max_{p_t, \Y_t} \left\{ p_t \  X_t - \sum_{j \in N_{\mathcal{A}}(i)} Y^j_t \  P^j(\Y_t) + \lambda_t \  \left( X_t - \sum_{j \in N_{\mathcal{A}}(i)} Y^j_t \right) + \beta \   V(X_{t+1}, S_{t+1}) \right\}
\end{equation*}

where,

\begin{equation*}
  \begin{split}
    X_{t+1} &= X_t - \B \left[R(p_t, S_t) \right] \\
    S_{t+1} &= S_t + \B \left[R(p_t, S_t) \right]
  \end{split}
\end{equation*}

Optimization with respect to the price $p_t$, yields,

\begin{equation}
  X_t = \beta \ \gamma_{t} \ \left[\frac{\partial V}{\partial X_{t+1}} - \frac{\partial V}{\partial S_{t+1}}  \right]
\end{equation}

This first order condition requires that the marginal benefit of exploiting current excess demand $X$ should equal the believed marginal benefit loss, $ \beta \left[\frac{\partial V}{\partial X_{t+1}} - \frac{\partial V}{\partial S_{t+1}}  \right] $, of reducing excess demand next period, $\gamma_{t}$. On the other hand, the first order condition with respect to an arbitrary traded quantity $Y^j_t$ is,

\begin{equation}
  \sum_{j \in N_{\mathcal{A}}(i)} \frac{\partial (Y_t^j \  P_t^j(\Y_t))}{\partial Y_t^m} = -\lambda_t.
\end{equation}

This equation tells us that in equilibrium providers will allocate the quantities traded with neighbors, $Y^j$, in such a way that marginal benefits are all equal. The optimization yields the policy function for local prices (see Appendix \ref{a:provider_optimization}),

\begin{equation} \label{local_p}
  p_{t+1} = p_t + \frac{1-\beta}{\beta \ \gamma} X_t + \frac{\alpha + \eta S_t}{\gamma} - \lambda_{t+1}
\end{equation}

\subsubsection{Bargaining model}

Given the evolution of the local price (\ref{local_p}), it is necessary to solve the bargaining model between providers (which determines the shadow price of acquiring outside electricity $\lambda_t$). To do so I first impose a ``direction'' of trade, namely a traded quantity $Y^{(i, j)}$ enters positively in $j$ and negatively in $i$, such that

\begin{equation}
  Y^{(i, j)} = -Y^{(j, i)}
\end{equation}

Furthermore we can rewrite the summation over the neighbors using $\matr{A}$, the adjacency matrix of the graph $\mathcal{A}$, with entries $a_{i, j}$, such that the instantaneous payoff of provider $i$ can be written as,

\begin{equation}
  \begin{split}
    \Pi_{i, t} &= X_{i, t} \  p_{i, t} - \sum_{j \in N_{\mathcal{A}}(i)} Y_t^{(i, j)} \  P_t^{(i, j)} \\
    &= X_{i, t} \  p_{i, t} - \sum_{j \in V} a_{i, j} \  Y_t^{(i, j)} \  P_t^{(i, j)}
  \end{split}
\end{equation}

I assume that the bargaining does not take into account individual market expectations and that it happens after the demand is already determined, such that $P$ is a function of $p$ only via $\Y$. The Nash bargaining solution is such that,

\begin{equation}
  P_t^{(i, j)} = \arg \max_{P_t^{(i, j)}} \left\{\Pi_{i, t} \  \Pi_{j, t} \right\}.
\end{equation}


which yields (see \ref{a:barsol}), for every edge $(i, j)$ with $a_{i, j} \neq 0$,

\begin{equation} \label{bargaining_solution}
  \begin{split}
    P_t^{(i, j)} = \frac{1}{2\  Y_t^{(i, j)}} \Biggl( &\underbrace{X_{i, t} \  p_{i, t} - X_{j, t} \  p_{j, t}}_{\text{revenue difference }}
    \\  + &\underbrace{\sum_{m\in N\setminus \set{i}} a_{j, m} \  Y_t^{(j, m)} \  P_t^{(j, m)}}_{\text{outside option of } j}
    \\ - & \underbrace{\sum_{m \in N\setminus \set{j}} a_{i, m} \  Y_t^{(i, m)} \  P_t^{(i, m)}}_{\text{outside option of } i} \Biggr).
  \end{split}
\end{equation}


In the bargaining problem we have a set of directed edges $E = \set{i \to j: i, j \in N}$. On each edge a bargaining price and a transferred quantity is determined. This defines the two vectors $P, \ Y \in \R^{\abs{E}}$. Now, let $\Delta_t$ in $\R^{\abs{E}}$ be the vector of revenue difference in the respective local markets with entries,

\begin{equation}
  \Delta^{(i, j)}_t \coloneqq X_{i, t} \  p_{i, t} - X_{j, t} \  p_{j, t}
\end{equation}

Given the adjacency matrix of $L(\mathcal{A})$, $\G$, and $\Delta^{(i, j)}_t$, at each step $t$, equation (\ref{bargaining_solution}) can be written as,

\begin{equation} \label{matrix_bargaining_solution}
  \begin{split}
    2(P \circ \Y) &= \Delta  - \G \left( P \circ \Y \right) \\
    (2\I + \G) (P \circ \Y) &= \Delta  \\
    (P \circ \Y) &= (2\I + \G)^{-1} \Delta \\
    P &= \left((2\I + \G)^{-1} \Delta \right) \oslash \Y
  \end{split}
\end{equation}

where $\circ$ and $\oslash$ denote the element-wise (Hadamard) product and division. Hence, the bargaining solution gives the following price formation,

\begin{equation} \label{Pmatrix}
  P(\Y_t) = \left((2\I + \G)^{-1} \Delta_t \right) \oslash \Y_t
\end{equation}

with associated Jacobian (see \ref{a:jacobian_p}),

\begin{equation} \label{Pjacobian}
  D_{\Y} P(\Y_t) = -\diag(P(\Y_t) \oslash \Y_t).
\end{equation}

Equation (\ref{Pmatrix}) shows that the trading prices on an edge, $P^{(i, j)}$, depends only on the state of the edges' two nodes, via $Y^{(i, j)}_t$, the revenue differences across the network, via $\Delta_t$, and the network structure. This function also highlights a pitfall of the Nash bargaining procedure on networks. In particular, if the graph $\mathcal{A}$ contains a cycle, the matrix $(2\I + \G)^{-1}$ is singular, given that the number of equations at our disposable to determine $P(\Y_t)$ is not sufficient. To see this consider the simple case of adding an extra edge in the graph below (left to right). On the right graph we demand a further unknown, $P^{(2, 3)}$, but we do not provider further equations.

\begin{figure}[H]
  \centering
  \resizebox{\linewidth}{!}{\input{sections/diagrams/cycleissue.tikz}}
\end{figure}

This can be also seen by looking at the two $\det(2 \I + \G)$,

\begin{equation*}
  \text{the first, }
  \det \begin{pmatrix}
    2 & 1 \\
    1 & 2
  \end{pmatrix}  = 3 \text{ and the second, }
  \det \begin{pmatrix}
    2  & 1 & -1 \\
    1  & 2 & 1  \\
    -1 & 1 & 2
  \end{pmatrix} = 0.
\end{equation*}

Because of this limitation, here I will limit the analysis to acyclic (or complete) graphs. Extending this model to cyclical graphs simply requires defining a more general once differentiable function $P: \R^{\abs{V}} \to \R^{\abs{E}}$, that models the bargaining procedure.

Now we can use Equations (\ref{Pmatrix}) and (\ref{Pjacobian}), combined with the local optimization, to obtain an explicit expression of the shadow price of the bargaining procedure, $\lambda_t$. Using the fact that $D_{\Y} P(\Y_t)_{e_1, e_2} = 0$ if $e_1 \neq e_2$ and $D_{\Y} P(\Y_t)_{i, j} = \pm 1$ (i.e. no direct dependence between $P^{(i, j)}$ and $P^{(l, m)}$ for $(i, j) \neq (l, m)$), the shadow price of the bargaining procedure (Equation \ref{lambda}) can be written as,


\begin{equation}
  \begin{split}
    -\lambda_t &= P^m(\Y_t) + \sum_{j \in N_{\mathcal{A}}(i)} Y_t^j \  D_{\Y} P(\Y_t)_{j, m} \\
    &= 2 P^m(\Y_t)
  \end{split}
\end{equation}

Note that $\lambda_t$ needs to be the same for every neighbor, such that, for two neighbors $m$ and $n$,

\begin{equation}
  \begin{split}
    2 P^m(\Y_t) &= 2 P^n(\Y_t) \\
    \frac{P^n(\Y_t)}{P^m(\Y_t)} &= 1
  \end{split}
\end{equation}

This equation determines the ratio of $Y^{(i, m)}_t / Y^{(i, n)}_t$ for each element of the vector of $\matr{Y}_t$. Furthermore, to satisfy the resource constraint, it needs to be true that, $\sum_{j} Y^{(i, j)}_t = X_{i, t}$. These two equations allow to fully determine the vector $\matr{Y}_t(X_t, p_t)$.


\subsubsection{Making sense of the policy function}

Having derived the budget constraint on the bargained quantity, we can rewrite Equation (\ref{local_p}) as

\begin{equation} \label{local_p_comp}
  p_{t+1} = p_t + \frac{1-\beta}{\beta \ \gamma_t} X_t + \frac{\alpha_t + \eta_t \ S_t}{\gamma_t} + 2P^m(\matr{Y}_{t})
\end{equation}

We can rewrite this to find the price increase equation, $\Delta p_t = p_{t+1} - p_t$, plotted in Figure \ref{fig:p},

\begin{equation*}
  \Delta p_t (X_t, S_t, \matr{Y}_t) = \frac{1}{\gamma_t} \left( \frac{1-\beta}{\beta} X_t + \alpha_t + \eta_t \ S_t \right) + 2P^m(\matr{Y}_{t}).
\end{equation*}

First, this equation establishes a clear relationship between $X_t$ and price increases. If there is excess demand in the local market, $X_t > 0$, then an increase in its magnitude yields an increase of the price in order to increase production. Likewise, if $X_t < 0$, an increase in the excess supply leads to a decrease in the price to lower electricity production. It is important to notice that the provider sets the price $p_{t+1}$, based on data at time $t$, which affects the electricity production at time $t+1$. Second, assume without loss of generality, $X_t > 0$. If the cost of acquiring electricity from abroad, $P^m(\matr{Y}_{t})$, increases the producer will increase the price in the local market, $\Delta p_{t} > 0$, in order to increase local production. Hence this expression gives a clear mechanism of the transmission between prices in the cross-border market and the regional wholesale market.

\begin{figure}[H]
  \centering
  \includegraphics[width=\textwidth]{\plotpath/pricing.pdf}
  \caption{Price increases for different values of $X_t$ and $\lambda_t$}
  \label{fig:p}
\end{figure}

\subsubsection{Belief update}

Providers approximate the ramp-up production function of the local producers using a linear rule,

% FIXME: Talk about consistency

\begin{equation}
  \B_{t} \left[R(p_t, S_t) \right] = \alpha_{t} + \gamma_{t} \  p + \eta_{t} \ S.
\end{equation}

I assume that each period providers observe the realization $R_{t+1}$ and pick the coefficients $\alpha_{t+1}$, $\gamma_{t+1}$, and $\eta_{t+1}$ via weighted least squares, more precisely

\begin{equation}
  \begin{pmatrix}
    \alpha_{t+1} \\
    \gamma_{t+1} \\
    \eta_{t+1}
  \end{pmatrix} = ( \matr{\chi}_{t}^T \matr{W}  \matr{\chi}_{t})^{-1} ( \matr{\chi}_{t}^T \matr{W} \matr{R}_{t+1})
\end{equation}

where,
\begin{equation}
  \matr{\chi}_{t} = \begin{pmatrix}
    1      & p_0    & S_0    \\
    1      & p_1    & S_1    \\
    \vdots & \vdots & \vdots \\
    1      & p_t    & S_t
  \end{pmatrix} \text{ and } \matr{R}_t = \begin{pmatrix}
    R_{1}  \\
    R_{2}  \\
    \vdots \\
    R_{t + 1}
  \end{pmatrix}
\end{equation}

and $\matr{W}$ is a weighting matrix of time exponential decay with entries,

\begin{equation}
  \matr{W}_{t_1, t_2} = \exp(-\abs{t_1 - t_2})
\end{equation}

To recap the belief structure of the model,

\begin{table}[h!]
  \centering
  \input{sections/tables/perception.tex}
  \caption{Assumptions made by agents on other's processes}
  \label{table:perception}
\end{table}
