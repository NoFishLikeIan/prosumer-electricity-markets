\documentclass[../main.tex]{subfiles}
\section{Model}

The model focuses on two aspects of the cross-border electricity market. First, it models explicitly the bilateral trading procedure among electricity providers in the wholesale electricity market, which is a common mechanism of price setting, particularly in cross-border daily contracts in the EU and USA (\cite{Imran2014}). Doing this requires simplifying greatly the electricity market structure, particularly the different time scales at which operators trade, the intra-border competition, and the complex financial instruments. Nevertheless, these aspects can be approximated in my model by tweaking the network structure and these simplifications allows to concentrate on the bargaining-power induced by the graph, and the instabilities these might induce.

\begin{figure}[!ht]
    \centering
    \input{sections/diagrams/overview.tikz}
    \caption{A stylized model structure}
    \label{tikz:model}
\end{figure}

\begin{figure}[!ht]
    \centering
    \input{sections/diagrams/timing.tikz}
    \caption{Model timing}
    \label{tikz:timing}
\end{figure}

\subsection{Prosumers}

Prosumers are endowed an electricity quantity. The endowment follows a Markov process with some persistence $\rho$, $e_t \sim \matr{\pi}_{e}$, and a low and high state $\overline{e}$ and $\underline{e}$. Prosumers have a constant electricity consumption, the rest is sold. This can be encoded by making,

\begin{equation}
    \overline{e} > 0 \text{ and } \underline{e} < 0
\end{equation}

\subsection{Producers}

Let $s$ be the electricity production and $c(s)$, $c^\prime(s) > 0$, cost of ramping up production next period by $r$

\begin{equation}
    \begin{split}
        V(s_t) &= \max_{r_t \in [0, \bar{r}]} \left\{ s_t \cdot p_t - c(s_t) \cdot r_t + \beta \cdot \E_t V(s_{t+1}) \right\} \\
        \text{ s.t. } s_{t+1} &= \gamma \cdot s_t + r_t \\ s_t &\geq 0 \text{ and } s_0 = 0
    \end{split}
\end{equation}

Bounded rationality,

\begin{equation}
    \E_{\psi_t}[p_{t+1}] = \psi_t \cdot p_t + k, \ \psi_t \in \Psi, k \in \R^+
\end{equation}


Given that $\E\left[p_{t+1}\right]$ is linear, we can solve as a deterministic dynamic optimization problem. Then,

\begin{equation}
    \begin{split}
        V(s) &= \max_{r \in [0, \bar{r}]} J(r, s) \\
        &= \max_{r \in [0, \bar{r}]} \left\{ s \cdot p - c(s) \cdot r + \beta \cdot V(\gamma \cdot s + r) \right\}
    \end{split}
\end{equation}

FOCs

\begin{equation}
    \frac{\partial J(r, s)}{\partial r} = 0 \implies \beta \cdot V^\prime (\gamma \cdot s + r) = c(s)
\end{equation}

Given $r = \arg\max_{r \in [0, \bar{r}]} J(r, s)$ and assuming an interior solution, by the envelope theorem, % TODO: is J cont. differentiable?

\begin{equation}
    \begin{split}
        V^\prime (s) &= p - c^\prime(s) \cdot r + \beta \cdot V^\prime(\gamma \cdot s + r) \cdot \gamma \\
        &= p - c^\prime(s) \cdot r + c(s) \cdot \gamma
    \end{split}
\end{equation}

By iterating forward,

\begin{equation}
    \begin{split}
        V^\prime (\gamma \cdot s + r) &= \E[p] - c^\prime(\gamma \cdot s + r) \cdot r + c(\gamma \cdot s + r) \cdot \gamma \\
        \frac{c(s)}{\beta} &= \E[p] - c^\prime(\gamma \cdot s + r) \cdot r + c(\gamma \cdot s + r) \cdot \gamma
    \end{split}
\end{equation}

\subsubsection{Linear costs}

If $c(s) = c \cdot s$, hence $c^\prime(s) = c$,

\begin{equation}
    \begin{split}
        \frac{c \cdot s}{\beta} &= \E[p] - c \cdot r + c \cdot \gamma^2 \cdot s + c \cdot r \cdot \gamma \\
        \frac{s}{\beta} &= \frac{\E[p]}{c} - r + \gamma^2 \cdot s + r \cdot \gamma \\
        (1 - \gamma) \cdot r &= \frac{\E[p]}{c} - \frac{s}{\beta} + \gamma^2 \cdot x
    \end{split}
\end{equation}

This yields the ramp up function,

\begin{equation}
    r(s, p; \psi) = \frac{1}{1-\gamma} \left[ \frac{\E_\psi[p]}{c} - \left( \frac{1}{\beta} - \gamma^2 \right) \cdot s \right]
\end{equation}

Hence,

\begin{equation} \label{foc_rp}
    \frac{\partial}{\partial p} r(s, p; \psi) = \frac{\psi}{(1-\gamma) \cdot c}
\end{equation}

\subsubsection{Local market demand and supply}

A producer of type $\psi$ supplies at time $t$,

\begin{equation}
    s_t = \gamma \cdot s_{t-1} + r(s_{t-1}, p_{t-1}; \psi_{t-1})
\end{equation}

Aggregating over $N$ producers yields,

\begin{equation} \label{supply_motion}
    \begin{split}
        S_t(p_{t-1}) &= \sum^N_{i = 1} \left[ \gamma \cdot s_{i, t-1} + r(s_{i, t-1}, p_{t-1}; \psi_{i, t-1}) \right] \\
        S_t(p_{t-1}) &= \gamma \cdot S_{t-1}(p_{t-2}) + \sum^N_{i = 1}  r(s_{i, t-1}, p_{t-1}; \psi_{i, t-1})
    \end{split}
\end{equation}

This supply has to compensate the demand coming from prosumers. A local market with $M$ prosumers has aggregate demand at time $t$,

\begin{equation}
    X_t(p_{t-1}) = M \cdot e_t - S_t(p_{t-1})
\end{equation}

Iterating backwards we obtain,

\begin{equation}
    S_{t-1}(p_{t-2}) = M \cdot e_{t-1} - X_{t-1}(p_{t-2})
\end{equation}

which we ca use to rewrite Equation (\ref{supply_motion}),

\begin{equation}
    S_t(p_{t-1}) = \gamma \cdot \left[ M \cdot e_{t-1} - X_{t-1}(p_{t-2}) \right] + \sum^N_{i = 1}  r(s_{i, t-1}, p_{t-1}; \psi_{i, t-1}).
\end{equation}

Hence we obtain a law of motion of demand $X_t$ as,

\begin{equation}
    X_t(p_{t-1}) = \gamma \cdot X_{t-1}(p_{t-2}) + M \cdot \left( e_t - \gamma \cdot e_{t-1} \right) - \sum^N_{i = 1}  r(s_{i, t-1}, p_{t-1}; \psi_{i, t-1})
\end{equation}

\subsection{Providers}

\subsubsection{Notation}

Grid firms operate on a graph $\mathcal{A} = (V, E)$. Firms are nodes, $i \in V$, and they can trade if they share an edge, $(i, j) \in E$. I will indicate the neighbors of a node as,

\begin{equation}
    N_{\mathcal{A}}(i) = \set{ \ j \in V: \ (i, j) \in E \ }
\end{equation}

\subsubsection{Setup}

Each period, the optimization problem of the firm is,

\begin{equation}
    \max_{p_{i, t}, Y_{i, t}} \Pi_i(p_{i, t}, Y_{i, t})
\end{equation}

where $p_{i, t} \in \R_{+}$ and $Y_{i, t} \in \R^{\abs{N_{\mathcal{A}}(i)}}$. More precisely,

\begin{equation}
    \begin{split}
        \Pi_i(p_{i, t}, Y_{i, t}) &= p_{i, t} \cdot X_{i, t}(p_{i, t-1}) - \sum_{j \in N_{\mathcal{A}}(i)} Y_t^{(i, j)} \cdot P_t^{(i, j)} \\
        \text{ subject to } X_{i, t}(p_{i, t-1}) &=  \sum_{j \in N_{\mathcal{A}}(i)} Y_t^{(i, j)}
    \end{split}
\end{equation}

For now assume $P^{(i, j)}$ is determined by (i.e. is a function of) the vector of traded quantities $Y$, with elements $Y^{(i, j)}$ for every $(i, j) \in E$. Suppressing $i$ for convenience (i.e. $Y^j \coloneqq Y^{(i, j)}$), the Bellman equation is,

\begin{equation}
    \begin{split}
        V(X_t) &= \max_{p_t, Y_t} \left\{ p_t \cdot X_t - \sum_{j \in N_{\mathcal{A}}(i)} Y^j_t \cdot P(Y^j_t) + \beta \cdot \E \ V(X_{t+1}) \right\} \\
        &\text{subject to} \\
        X_{t+1} &= \gamma \cdot X_t + M \cdot \left( \E[e_{t+1}] - \gamma \cdot e_t \right) - \sum^N_{i = 1}  r(s_{i, t}, p_{t}; \psi_{i, t}) \\
        X_t &=  \sum_{j \in N_{\mathcal{A}}(i)} Y^j_t
    \end{split}
\end{equation}

\subsubsection{Euler equation}

Let,

\begin{equation*}
    \begin{split}
        L(p_t, Y_t) &\coloneqq p_t \cdot X_t - \sum_{j \in N_{\mathcal{A}}(i)} Y^j_t \cdot P(Y^j_t) + \\
        &+ \beta \cdot \E \ V\left(\gamma \cdot X_t + M \cdot \left( e_{t+1} - \gamma \cdot e_t \right) - \sum^N_{i = 1}  r_{i, t} \right) \\
        \text{where } r_{i, t} &\coloneqq r(s_{i, t}, p_{t}; \psi_{i, t}) \\
    \end{split}
\end{equation*}

such that $V(X_t) = \max_{p_t, Y_t} L(p_t, Y_t)$. The first order condition of $L$ requires that,

\begin{equation}
    \frac{\partial}{\partial p_t} L = X_t - \beta \cdot \E \left[V^\prime (X_{t+1}) \right] \cdot \sum^N_{i = 1}  \frac{\partial}{\partial p_t} r_{i, t} = 0
\end{equation}

where I used $\frac{\partial}{\partial p_t} X_t = 0$ and the linearity of the expectation $\E_\psi$ such that \begin{equation*}
    \E \left[V^\prime (X_{t+1}) \cdot \sum^N_{i = 1}  \frac{\partial}{\partial p_t} r_{i, t} \right] = \E \left[V^\prime (X_{t+1}) \right] \cdot \sum^N_{i = 1}  \frac{\partial}{\partial p_t} r_{i, t}.
\end{equation*}

If $c(x)$ is linear, we can use Equation (\ref{foc_rp}),

\begin{equation}
    \begin{split}
        \frac{\partial}{\partial p_t} L &= X_t - \beta \cdot \E \left[V^\prime (X_{t+1}) \right] \cdot \sum^N_{i = 1}  \frac{\partial}{\partial p_t} r_{i, t} \\
        &= X_t - \beta \cdot \E \left[V^\prime (X_{t+1}) \right] \cdot \sum^N_{i = 1} \frac{\psi_{i, t}}{(1-\gamma) \cdot c} \\
        &= X_t - \frac{N}{(1-\gamma) \cdot c} \cdot \left(\sum^N_{i = 1} \psi_{i, t} \right) \cdot \beta \cdot \E \ V^\prime (X_{t+1}) = 0
    \end{split}
\end{equation}

Letting $\Psi_t \coloneqq \sum^N_{i = 1} \psi_{i, t}$, we obtain,

\begin{equation} \label{foc_p}
    \beta \cdot \E \ V^\prime (X_{t+1}) = \frac{(1-\gamma) \cdot c}{N} \cdot \frac{X_t}{\Psi_t}
\end{equation}

The other first order condition requires, for all $j$,

\begin{equation} \label{foc_Y}
    \frac{\partial}{\partial Y^j_t} L = 0 \implies Y^j_t = - \frac{P^\prime(Y^j_t)}{ P(Y^j_t)}
\end{equation}

\subsubsection{Envelope}

Assuming we are in the optimum,

\begin{equation} \label{env}
    V^\prime(X_t) = p_t + \gamma  \cdot \beta \cdot \E \ V^\prime(X_{t+1})
\end{equation}

Combining Equations (\ref{env}) and (\ref{foc_p}), we obtain

\begin{equation}
    V^\prime(X_t) = p_t + \frac{\gamma \cdot (1-\gamma) \cdot c}{N} \cdot \frac{X_t}{\Psi_t}
\end{equation}

Iterating forward,

\begin{equation}
    \begin{split}
        V^\prime(X_{t+1}) &= p_{t+1} + \frac{\gamma \cdot  (1-\gamma) \cdot c}{N} \cdot \frac{X_{t+1}}{\Psi_{t+1}} \\
        \E \ V^\prime(X_{t+1}) &= p_{t+1} + \frac{\gamma \cdot  (1-\gamma) \cdot c}{N} \cdot \E \left[\frac{X_{t+1}}{\Psi_{t+1}} \right]
    \end{split}
\end{equation}

Using (\ref{foc_p}),

\begin{equation}
    \frac{(1-\gamma) \cdot c}{\beta \cdot N} \cdot \frac{X_t}{\Psi_t} = p_{t+1} + \frac{\gamma \cdot  (1-\gamma) \cdot c}{N} \cdot \E \left[\frac{X_{t+1}}{\Psi_{t+1}} \right]
\end{equation}

hence we obtain the policy function,

\begin{equation}
    p_{t+1} = \frac{c \cdot (1 - \gamma)}{N} \cdot \left( \beta^{-1} \cdot \frac{X_t(p_{t-1})}{\Psi_t} - \gamma \cdot \E\left[ \frac{X_{t+1}(p_t)}{\Psi_{t+1}} \right] \right)
\end{equation}
