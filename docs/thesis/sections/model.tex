\documentclass[../main.tex]{subfiles}
\section{Model}

\begin{figure}[!ht]
    \centering
    \input{sections/diagrams/timing.tikz}
    \caption{Regional wholesale electricity market}
    \label{tikz:wholesale}
\end{figure}

The model (see Figure \ref{tikz:wholesale}) is composed of two market types (wholesale and cross-border) and three agent types (prosumers, providers, and producers). Each regional wholesale market contains $M$ homogenous prosumers, with perfectly inelastic demand, and $N$ heterogenous producers, who compete locally in quantity. The monopolist provider sets the local wholesale price, at which it sells to prosumers and buys from producers. In case of excess demand (supply) in the wholesale market, the provider acquires (sells) electricity in the cross-border market. Such market is assumed to function via bilateral trading in a network between providers. Possibility of trading is contingent on the presence of an edge between two regional markets.

\subsection{Prosumers}

Prosumers are endowed an electricity quantity from renewable energy and have a constant electricity demand. Hence, an individual prosumer demand is a Markov process with two states: one of high demand ($\overline{e}$), in case renewable energy production is low, and one of low demand ($\underline{e}$), in case renewable energy production is high. The Markov process has then a transition matrix given by,

\begin{equation}
    P_{\varepsilon} = \begin{pmatrix}
        \rho_{\underline{e}}    & 1 - \rho_{\underline{e}} \\
        1 - \rho_{\overline{e}} & \rho_{\overline{e}}
    \end{pmatrix}
\end{equation}

\subsection{Producers}

Electricity producers operate power plants and can generate electricity by ramping up or down production at a certain cost and with a one period delay. This electricity is sold on the local market at a price $p$ given by electricity providers and costs $k$ to maintain. Furthermore, they are naive about the price formation mechanism and assume prices to be constant, $p_{t+1} \cong p_{t}$,  hence indipendent of their production decisions. Let $s$ be the electricity production and $c(s, r)$ the cost of ramping up or turning down production next period by $r$. I assume only a portion $\gamma$ of the electricity production can be freely reduced each period. This setup leads to the following optimization problem.

\begin{equation} \label{bellman_prod}
    \begin{split}
        V(s_t, p_t) &= \max_{r_t \in [-\gamma \cdot s_t, \overline{r}]} \left\{ s_t \cdot (p_t - k) - c(s_t, r_t) \cdot r_t + \beta \cdot V(s_{t+1}, p_{t+1}) \right\} \\
        \text{ s.t. } s_{t+1} &= s_t + r_t \text{ with } s_t \geq 0, s_0 \\
        p_{t+1} &= p_t
    \end{split}
\end{equation}

This optimization problem gives (see \ref{a:producer_optimization}) an implicit definition for $r$ as a function of $s$ and $p$,

\begin{equation} \label{raw_policy_producer}
    \begin{split}
        r(s_t, p_t): \R^2 \mapsto \R &\text{ such that,} \\
        \frac{\partial c}{\partial r}(s_t, r) \cdot r + c(s_t, r) &= \beta \cdot \left\{p_t - k + \left[\frac{\partial c}{\partial r}(s_t + r, r) - \frac{\partial c}{\partial s_t}(s_t + r, r)\right] \cdot r + c(s_t + r, r) \right\} \\
        mc(r; s_t, p_t) &= \beta \cdot \{ mb(r; s_t, p_t) \}
    \end{split}
\end{equation}

The left hand side ($mc$) is the marginal cost today of ramping up production today. The producer by ramping up production pays $c(s_t, r)$ and increases the costs of ramping up by $\frac{\partial c}{\partial r}(s_t, r) \cdot r$. The right hand side ($mb$) is the marginal benefit tomorrow of ramping up production today. It can be broken up into the price the prosumer believes they can get for the new production, $p_t$, the avoided marginal cost tomorrow of having increased production today instead, $\frac{\partial c}{\partial r}(s_t + r, r)  \cdot r + c(s_t + r, r)$, and finally the increased marginal cost brought about by a higher level of production $\frac{\partial c}{\partial s_t}(s_t + r, r)$.

\iffalse % TODO: Add quadratic?

    To build some intuition over $r$, consider a simple quadratic cost function $c(s, r) = r$ (see Figure \ref{fig:quadcosts}). This function allows us to explicitly derive,

    \begin{equation}
        \begin{split}
            mc(r; s_t, p_t) &= 2r \\
            mb(r; s_t, p_t) &= p_t - k + 2r
        \end{split}
    \end{equation}

    such that,

    \begin{equation}
        r(s_t, p_t) = \frac{\beta}{2 (1 - \beta)}  \left(p_t - k \right)
    \end{equation}

    \begin{figure}[!ht]
        \centering
        \includegraphics[width=\textwidth]{\plotpath/quadcosts.pdf}
        \caption{Quadratic cost function and an instance of solution}
        \label{fig:quadcosts}
    \end{figure}

\fi

Clearly, the ramp-up policy function will depend entirely on the choice of the marginal cost function, $c(s, r)$. Intuitevely ramping down should have no costs, namely $c(s, r) = 0$ if $r < 0$, and should have increasing marginal costs both in scale of supply, $\partial c / \partial s > 0$, and in ramp-up level, $\partial c / \partial r > 0$. A differentiable function with (asymptotically) this feature is the sofplus function, sketched for some state $s = 10$ in Figure \ref{fig:costs},

\begin{equation}
    c(s, r; c_1) \coloneqq \frac{1}{c_1} \cdot \log \left( 1 + \exp(c_1 \cdot s \cdot r) \right)
\end{equation}

In particular, notice that $c(s, r; c_1) \xrightarrow{} \max \{ 0, s \cdot r \}$ as $c_1 \xrightarrow{}\infty$.

\begin{figure}[!ht]
    \centering
    \includegraphics[width=\textwidth]{\plotpath/cost.pdf}
    \caption{Softplus cost function}
    \label{fig:costs}
\end{figure}

At the limit $c_1 \xrightarrow{}\infty$, we can define the policy function  $r(s_t, p_t)$ analytically (see \ref{a:limiting}). This ``asymptotic'' policy function is continuous everywhere but differentiable only within three intervals. The first trivial interval to consider is the space where $p_t < k$. Here producers make a loss at each unit sold ($mc(r) > \beta \cdot mb(r)$) hence they will try and reduce production as much as possible, namely $r(s_t, p_t) = -\gamma \cdot s_t$. The second interval is that were current electricity production is too low, namely $s_t < \frac{\beta}{1- \beta} \sqrt{p_t - k}$ (which implies $mc(r) < \beta \cdot mb(r)$). In this case, ramp-up will be as high as possible $r(s_t, p_t) = \overline{r}$. The interesting case is that of values where $mc(r) = \beta \cdot mb(r)$.

\begin{equation} \label{rpolicy}
    r(s_t, p_t) =
    \frac{1 - \beta}{\beta} \cdot s_t - \frac{1}{2} \sqrt{ \left(\frac{1 - \beta}{\beta} \cdot 2 s_t \right)^2 - 4 \cdot \left(p_t - k\right) }
\end{equation}

The ramp function is plotted in Figure $\ref{fig:r}$.

\begin{figure}[!ht]
    \centering
    \includegraphics[width=\textwidth]{\plotpath/rfunction.pdf}
    \caption{Ramp-up function with softplus costs}
    \label{fig:r}
\end{figure}

\subsubsection{Local demand}

Given any ramp-up policy function $r(s, p)$, it is possible to find the \textit{excess} demand of electricity in the local market, that is, the electricity demanded in the local market by local prosumers that it is not satisfied by local producers. First, let $R_t$ be the aggregated ramp-up function,

\begin{equation}
    R_{t}(p_t) \coloneqq \sum^N_{i = 1} r(s_{i, t}, p_t)
\end{equation}

Assuming that the local market is composed of $N$ producers and $M$ prosumers, the aggregate supply of electricity at time $t$, can be written as,

\begin{equation}
    \begin{split}
        \sum^N_{i = 1} s_{i, t+1} &= \sum^N_{i = 1} \left( s_{i, t} +  r(s_{i, t}, p_t) \right)\\
        S_{t+1} &= S_t + R_{t}(p_t)
    \end{split}
\end{equation}

The electricity demanded by $M$ prosumers is fully determined by the Markov chain of electricity endowments $e_t$. Furthermore, I assume that this demand is completely inelastic, namely prosumers will buy electricity at any price from providers or directly from producers. Hence the excess electricity demand at time $t$ is simply the difference between the demand and the supply,

\begin{equation} \label{x_inst}
    X_{t} = M \cdot e_{t} - S_{t}
\end{equation}

Note that if $S_t > M \cdot e_t$, there is an excess supply ($X_t < 0$) of electricity in the local market that the local provider can use to sell abroad. This happens in the case of a good endowment of electricity $e_t < 0$. Given equation (\ref{x_inst}), we obtain the evolution of the process $X_t$ (see \ref{a:ev_demand}),

\begin{equation} \label{x_true}
    X_{t+1} = X_t + M \cdot \left(e_{t+1} - e_t \right) -  R_t
\end{equation}


\subsection{Providers}

\begin{figure}[!ht]
    \centering
    \input{sections/diagrams/overview.tikz}
    \caption{An instance of the cross-border electricity market}
    \label{tikz:cb}
\end{figure}


% FIXME: This paragraph

Electricity providers are monopolist in their own local market and are indexed, as is their local market, by $i$. They set the local price $p_{i, t}$ at which they sell (purchase) the excess demand (supply) of electricity in the local market $X_{i, t}$. On the one hand, if there is excess demand in the market, $X_{i, t} > 0$, providers sell electricity to prosumers at price $p_{i, t}$. On the other hand, if there is excess supply, $X_{i, t} < 0$, they buy electricity off of prosumers and producers at price $p_{i, t}$. The excess demand (supply) is satisfied (sold) by trading with other providers in the network. Hence, providers trade electricity $Y^{(i, j)}$, at a bargained price $P^{(i, j)}$, with neighboring providers. $Y^{(i, j)} > 0$ if $i$ is buying from $j$ and viceversa for $Y^{(i, j)} < 0$. This also implies that $Y^{(i, j)} = -Y^{(j, i)}$.Providers operate on a graph $\mathcal{A} = (V, E)$ and can trade only if they share an edge, $(i, j) \in E$. Let the neighbors of a node be the set,

\begin{equation}
    N_{\mathcal{A}}(i) \coloneqq \set{ \ j \in V: \ (i, j) \in E \ }
\end{equation}

Given this, each period, the optimization problem of the firm is,

\begin{equation}
    \max_{p_{i, t}, \Y_{i, t}} \Pi_i(p_{i, t}, \Y_{i, t})
\end{equation}

where $p_{i, t} \in \R_{+}$ and

\begin{equation}
    \begin{split}
        \Y_{i, t} &\in \R^{\abs{N_{\mathcal{A}}(i)}}, \hspace{5mm}\Y_{i, t} = \begin{pmatrix}
            Y^{(i, 1)}_t \\
            Y^{(i, 2)}_t \\
            \vdots
        \end{pmatrix}
    \end{split}
\end{equation}

is a vector of traded quantities with the provider's neighbors. Expanding the provider's payoff,

\begin{equation}
    \begin{split}
        \Pi_i(p_{i, t}, \Y_{i, t}) &= p_{i, t} \cdot X_{i, t}(p_{i, t-1}) - \sum_{j \in N_{\mathcal{A}}(i)} Y_t^{(i, j)} \cdot P_t^{(i, j)} \\
        \text{ s.t. } X_{i, t}(p_{i, t-1}) &=  \sum_{j \in N_{\mathcal{A}}(i)} Y_t^{(i, j)}
    \end{split}
\end{equation}

The condition $X_{i, t}(p_{i, t-1}) =  \sum_{j \in N_{\mathcal{A}}(i)} Y_t^{(i, j)}$ requires the provider to always match (sell) the quantity demanded (supplied) in the local market by trading with its neighbors. For now, assume every pairwise price on the network, $P^{(i, j)}$, is determined only by the vector of traded quantities, $\Y$. The provider's optimization is an intertemporal problem that depends on the state $X_t$ which follows the evolution layed down in equation (\ref{x_true}). The provider is assumed to make two simplifying assumptions on this evolution. First, at time $t$, it assumes $M \cdot (\E[e_{t+1}] - e_{t}) \cong 0$. This assumption is a good approximation in the case of a very persistent Markov chain $e_t$ (i.e. if $\matr{\pi}_e \approx \matr{I}$). Second, I assume the provider does not know the ramp-up function of producers in the local market, $r(s_t, p_t)$, hence they approximate the aggregate ramp-up function by a linear adaptive rule, proportional to the price, namely $R_t(p) \cong a_t + b_t \cdot p$ with $a < 0$ and $b > 0$.

Given this setup we can specify the optimization problem of the provider. Suppressing $i$ for convenience (i.e. $Y^j \coloneqq Y^{(i, j)}$), the Bellman equation can be written as,

\begin{equation*}
    \begin{split}
        V(X_t) &= \max_{p_t, \Y_t} \left\{ p_t \cdot X_t - \sum_{j \in N_{\mathcal{A}}(i)} Y^j_t \cdot P^j(\Y_t) + \lambda_t \cdot \left( X_t - \sum_{j \in N_{\mathcal{A}}(i)} Y^j_t \right) + \beta \cdot  V(X_{t+1}) \right\} \\
        X_{t+1} &= X_t - \left( a_t + b_t \cdot p_t \right)
    \end{split}
\end{equation*}

Optimization with respect to the price $p_t$, requires,

\begin{equation}
    X = \beta \cdot V^\prime \left(X - \left( a_t + b_t \cdot p_t \right) \right) \cdot b_t
\end{equation}

This first order condition requires that the marginal benefit of exploting current excess demand $X$ should equal the perceived marginal benefit loss ($\beta \cdot V^\prime \left(X - \left( a_t + b_t \cdot p_t \right) \right)$) of reducing excess demand next period ($b_t$). On the other hand, the derivative with respect to an arbitrary traded quantity $Y^j_t$,

\begin{equation}
    \sum_{j \in N_{\mathcal{A}}(i)} \frac{\partial (Y_t^j \cdot P_t^j(\Y_t))}{\partial Y_t^m} = -\lambda_t,
\end{equation}

The optimization yields the policy function for local prices (\ref{a:provider_optimization}),

\begin{equation} \label{local_p}
    p_{t+1} = p_t + \frac{a_t}{b_t} +  \left( \frac{1 - \beta}{\beta} \right) \cdot \frac{X_t}{b_t} - \lambda_{t+1}
\end{equation}

\subsubsection{Bargaining model}

Given the evolution of the local price (\ref{local_p}), it is necessary to solve the bargaining model between providers (which determines the shadow price of acquiring outside electricity $\lambda_{t+1}$). To do so I first impose a ``direction'' of trade, namely a traded quantity $Y^{(i, j)}$ enters positively in $j$ and negatively in $i$, such that

\begin{equation}
    Y^{(i, j)} = -Y^{(j, i)}
\end{equation}

Furthermore we can rewrite the summation over the neighbors using $\matr{A}$, the adjacency matrix of the graph $\mathcal{A}$, with entries $a_{i, j}$, such that the instantaneous payoff of provider $i$ can be written as,

\begin{equation}
    \begin{split}
        \Pi_{i, t} &= X_{i, t} \cdot p_{i, t} - \sum_{j \in N_{\mathcal{A}}(i)} Y_t^{(i, j)} \cdot P_t^{(i, j)} \\
        &= X_{i, t} \cdot p_{i, t} - \sum_{j \in V} a_{i, j} \cdot Y_t^{(i, j)} \cdot P_t^{(i, j)}
    \end{split}
\end{equation}

I assume that the bargaining does not take into account individual market expectations and that it happens after the demand is already determined, such that $P$ is a function of $p$ only via $Y$. The Nash bargaining solution is such that,

\begin{equation}
    P_t^{(i, j)} = \arg \max_{P_t^{(i, j)}} \left\{\Pi_{i, t} \cdot \Pi_{j, t} \right\}.
\end{equation}


which yields (see \ref{a:barsol}), for every edge $(i, j)$ with $a_{i, j} \neq 0$,

\begin{equation} \label{bargaining_solution}
    \begin{split}
        P_t^{(i, j)} = \frac{1}{2\cdot Y_t^{(i, j)}} \Biggl( &\underbrace{X_{i, t} \cdot p_{i, t} - X_{j, t} \cdot p_{j, t}}_{\text{revenue difference }}
        \\  + &\underbrace{\sum_{m\in N\setminus \set{i}} a_{j, m} \cdot Y_t^{(j, m)} \cdot P_t^{(j, m)}}_{\text{outside option of } j}
        \\ - & \underbrace{\sum_{m \in N\setminus \set{j}} a_{i, m} \cdot Y_t^{(i, m)} \cdot P_t^{(i, m)}}_{\text{outside option of } i} \Biggr).
    \end{split}
\end{equation}


In the bargaining problem we have a set of directed edges $E = \set{i \to j: i, j \in N}$. On each edge a bargaining price and a transferred quantity is determined. This defines the two vectors $P, \ Y \in \R^{\abs{E}}$. One can therefore simplify the solution by using the directed line graph associated with the original graph, with adjacency matrix $\matr{G} \in \R^{\abs{E}\times \abs{E}}$. First, let $\Delta_t$ in $\R^{\abs{E}}$ be the vector of revenue difference in the respective local markets with entries,

\begin{equation}
    \Delta^{(i, j)}_t \coloneqq X_{i, t} \cdot p_{i, t} - X_{j, t} \cdot p_{j, t}
\end{equation}

At each time $t$, equation (\ref{bargaining_solution}) can be then written as,

\begin{equation} \label{matrix_bargaining_solution}
    \begin{split}
        2(P \circ \Y) &= \Delta  - \matr{G} \left( P \circ \Y \right) \\
        (2\matr{I} + \matr{G}) (P \circ \Y) &= \Delta  \\
        (P \circ \Y) &= (2\matr{I} + \matr{G})^{-1} \Delta \\
        \diag(\Y) P &=  (2\matr{I} + \matr{G})^{-1} \Delta \\
        P &= \diag(\Y)^{-1} (2\matr{I} + \matr{G})^{-1} \Delta
    \end{split}
\end{equation}

where $\circ$ denotes the element-wise (Hadamard) product. Hence, the bargaining solution gives the price following price formation,

\begin{equation}
    P(\Y_t) = \diag(\Y_t)^{-1} (2\matr{I} + \matr{G})^{-1} \Delta
\end{equation}

with associated Jacobian (see \ref{a:jacobian_p}),

\begin{equation}
    D_{\Y} P(\Y_t) = -\diag(P(\Y_t) \oslash \Y_t)
\end{equation}

We can use this, combined with the local optimization $\lambda_t$, to obtain an explicit expression of the local optimization. Using the fact that $D_{\Y} P(\Y_t)_{i, j} = 0$ if $i \neq j$ and $D_{\Y} P(\Y_t)_{i, j} = 1$ if $i < j$, the shadow price of the bargaining procedure (Equation \ref{lambda}) can be written as,


\begin{equation}
    \begin{split}
        -\lambda_t &= P^m(\Y_t) + \sum_{j \in N_{\mathcal{A}}(i)} Y_t^j \cdot D_{\Y} P(\Y_t)_{j, m} \\
        &= 2 P^m(\Y_t)
    \end{split}
\end{equation}

Note that $\lambda_t$ needs to be the same for every neighbour, such that, for two neighbours $m$ and $n$,

\begin{equation}
    \begin{split}
        2 P^m(\Y_t) &= 2 P^n(\Y_t) \\
        \frac{P^n(\Y_t)}{P^m(\Y_t)} &= 1
    \end{split}
\end{equation}

This equation determines the ratio of $Y^{(i, m)}_t / Y^{(i, n)}_t$ for each element of the vector of $\matr{Y}_t$. Furthermore, to satisfy the resource constraint, it needs to be true that, $\sum_{j} Y^{(i, j)}_t = X_t$. These two equations allow to fully determine the vector $\matr{Y}_t$.


\subsubsection{Policy function}

Having derived the budget constraint on the bargained quantity, we can rewrite Equation (\ref{local_p}) as

\begin{equation} \label{local_p_comp}
    p_{t+1} = p_t + \frac{a_t}{b_t} + \left( \frac{1 - \beta}{\beta} \right) \cdot \frac{X_t}{b_t} + 2P^m(\matr{Y}_{t})
\end{equation}

First, this equation enstablishes a clear relationship between $X_t$ and $p_{t+1}$. If there is excess demand in the local market, $X_t > 0$, then an increase in its magnitude yields an increase of the price in order to increase production. Likewise, if $X_t < 0$, an increase in the excess supply leads to a decrease in the price to lower electricity production. It is important to notice that the provider sets the price $p_{t+1}$, based on data at time $t$, which affects the electricity production at time $t+1$. Second, assume without loss of generality $X_t > 0$. If the cost of acquiring electricity from abroad, $P^m(\matr{Y}_{t})$, increases the producer will increase the price in the local market, $p_{t+1}$, in order to increase local production. Hence this expression gives a clear mechanism of the trasmission between prices in the cross-border market and the regional wholesale market.

\subsubsection{Belief update}

Providers approximate the ramp-up production function of the local producers using a linear rule,

\begin{equation}
    R_{t+1}(p_t) \cong a_t + b_t \cdot p_t
\end{equation}

I assume that each period providers observe the realization $R_{t+1}(p_t)$ and pick the coefficients $a_{t+1}$ and $b_{t+1}$ via weighted least squares, more precisely

\begin{equation}
    \begin{pmatrix}
        a_{t+1} \\
        b_{t+1}
    \end{pmatrix} = (\matr{p}_{t}^T \matr{W} \matr{p}_{t})^{-1} (\matr{p}_{t}^T \matr{W} \matr{R}_{t+1})
\end{equation}

where,
\begin{equation}
    \matr{p}_{t} = \begin{pmatrix}
        1      & p_0    \\
        1      & p_1    \\
        \vdots & \vdots \\
        1      & p_{t}
    \end{pmatrix} \text{ and } \matr{p}_t = \begin{pmatrix}
        R_{1}  \\
        R_{2}  \\
        \vdots \\
        R_{t + 1}
    \end{pmatrix}
\end{equation}

and $\matr{W}$ is a weighting matrix of time exponential decay with entries,

\begin{equation}
    \matr{W}_{t_1, t_2} = \exp(-\alpha \cdot \abs{t_1 - t_2})
\end{equation}

To recap the belief structure of the model,

\begin{table}[h!]
    \centering
    \input{sections/tables/perception.tex}
    \caption{Assumptions made by agents on other's processes}
    \label{table:perception}
\end{table}
