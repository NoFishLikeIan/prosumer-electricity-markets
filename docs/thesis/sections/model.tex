\documentclass[../main.tex]{subfiles}
\section{Model}

The model focuses on two aspects of the cross-border electricity market. First, it models explicitly the bilateral trading procedure among electricity providers in the wholesale electricity market, which is a common mechanism of price setting, particularly in cross-border daily contracts in the EU and USA (\cite{Imran2014}). Doing this requires simplifying greatly the electricity market structure, particularly the different time scales at which operators trade, the intra-border competition, and the complex financial instruments. Nevertheless, these aspects can be approximated in my model by tweaking the network structure and these simplifications allows to concentrate on the bargaining-power induced by the graph, and the instabilities these might induce.

\iffalse
    \begin{figure}[!ht]
        \centering
        \input{sections/diagrams/overview.tikz}
        \caption{A stylized model structure}
        \label{tikz:model}
    \end{figure}

    \begin{figure}[!ht]
        \centering
        \input{sections/diagrams/timing.tikz}
        \caption{Model timing}
        \label{tikz:timing}
    \end{figure}
\fi

\subsection{Prosumers}

Prosumers are endowed an electricity quantity. The endowment follows a Markov process with some persistence $\rho$, $e_t \sim \matr{\pi}_{e}$, and a low and high state $\overline{e}$ and $\underline{e}$. Prosumers have a constant electricity consumption, the rest is sold. This can be encoded by making,

\begin{equation}
    \overline{e} > 0 \text{ and } \underline{e} < 0
\end{equation}


\subsection{Producers}

Electricity producers operate power plants and can generate electricity by ramping up or down production at a certain cost. This electricity is sold on the local market at a price $p$ given by electricity providers. Furthermore, they assume the price formation mechanism to be independent of their production decisions and approximate it by a linear adapting forecasting rule, $p_{\psi, t+1} = \psi \cdot p_{t}$. Let $s$ be the electricity production and $c(s)$, with $c^\prime(s) > 0$, the cost of ramping up or turning down production next period by $r$. This setup leads to the following optimization problem.

\begin{equation} \label{bellman_prod}
    \begin{split}
        V(s_t, p_t) &= \max_{r_t \in [\underline{r}, \bar{r}]} \left\{ s_t \cdot p_t - c(s_t) \cdot r_t + \beta \cdot V(s_{t+1}, p_{t+1}) \right\} \\
        \text{ s.t. } s_{t+1} &= s_t + r_t \text{ with } s_t \geq 0, s_0 \\
        p_{t+1} &= \psi \cdot p_t
    \end{split}
\end{equation}

This optimization problem gives (see \ref{a:producer_optimization}) an implicit definition for $r$ as a function of $s$ and $p$ given $\psi$,

\begin{equation}
    r = r(s, p; \psi) : \ c^\prime(s + r) \cdot r - c(s + r) = \psi \cdot p - \frac{c(s)}{\beta}
\end{equation}

\subsubsection{Local demand}
Given the ramp-up policy function $r(s, p; \psi)$, it is possible to find the \textit{excess} demand of electricity in the local market, that is, the electricity demanded in the local market by local prosumers that it is not satisfied by local producers.

Assume that the local market is composed of $N$ producers and $M$ prosumers. First, let $R_t$ be the aggregated ramp-up function,

\begin{equation}
    R_{t}(p_t) \coloneqq \sum^N_{i = 1} r(s_{i, t}, p_t; \psi_{i, t})
\end{equation}

Then, the aggregate supply of electricity at time $t$, can be written as,

\begin{equation}
    \begin{split}
        \sum^N_{i = 1} s_{i, t+1} &= \sum^N_{i = 1} \left( s_{i, t} +  r(s_{i, t}, p_t; \psi_{i, t}) \right)\\
        S_{t+1} &= S_t + R_{t}(p_t)
    \end{split}
\end{equation}

The electricity demanded by $M$ prosumers is fully determined by the Markov chain of electricity endowments $e_t$. Furthermore, I assume that this demand is completely inelastic, namely prosumers will buy electricity at any price from providers or directly from producers. Hence the excess electricity demand at time $t$ is simply the difference between the demand and the supply,

\begin{equation} \label{x_inst}
    X_{t} = M \cdot e_{t} - S_{t}
\end{equation}

Note that if $S_t > M \cdot e_t$, there is an excess supply ($X_t < 0$) of electricity in the local market that the local provider can use to sell abroad. This happens in the case of a good endowment of electricity $e_t < 0$. Given equation (\ref{x_inst}), we obtain the evolution of the process $X_t$ (see \ref{a:ev_demand}),

\begin{equation} \label{x_true}
    X_{t+1} = X_t + M \cdot \left(e_{t+1} - e_t \right) -  R_t
\end{equation}

\subsubsection{Belief update}

Producers approximate the price evolution by assuming prices will change by a factor $\psi$ each period. I assume that this factor is picked from a set $\Psi$. Let $\psi_{t}$ be the ``forecasting factor'' currently employed by a producer. Next period, the producer obtains an instantenous payoff,

\begin{equation}
    \begin{split}
        s_{t+1} &= s_t + r(s_{i, t}, p_t; \psi_{t}) \\
        u_{t+1} &= s_{t+1} \cdot p_{t+1} - c(s_{t+1}) \cdot r(s_{t+1}, p_{t+1}; \psi_{t})
    \end{split}
\end{equation}

Further, let $U_{\psi_h} = \sum^t_{\tau = 0} \mathbbm{1} \{\psi_{\tau} = \psi_h\} \cdot u_{\tau}$, that is, the cumulative sum of instantenous payoffs obtained while using factor $\psi_h$. Then producers update their forecasting rule by chossing the all time best performing factor, namely,

\begin{equation}
    \psi_{t+1} = \arg\max_{\psi_h} \frac{\exp(U_{\psi_h})}{\sum_{\psi \in \Psi} \exp(U_{\psi})}
\end{equation}


\subsection{Providers}

\subsubsection{Setup}

Electricity providers are monopolist in their own local market and are indexed, as is their local market, by $i$. They set the local price $p_{i, t}$ at which the sell (purchase) the excess demand (supply) of electricity in the local market $X_{i, t}$. They do so by trading electricity $Y^{(i, j)}$, at a bargained price $P^{(i, j)}$, with neighboring providers. Providers operate on a graph $\mathcal{A} = (V, E)$ and can trade if they share an edge, $(i, j) \in E$. Let the neighbors of a node be the set,

\begin{equation}
    N_{\mathcal{A}}(i) \coloneqq \set{ \ j \in V: \ (i, j) \in E \ }
\end{equation}

Given this, each period, the optimization problem of the firm is,

\begin{equation}
    \max_{p_{i, t}, Y_{i, t}} \Pi_i(p_{i, t}, \Y_{i, t})
\end{equation}

where $p_{i, t} \in \R_{+}$ and

\begin{equation}
    \begin{split}
        \Y_{i, t} &\in \R^{\abs{N_{\mathcal{A}}(i)}}, \hspace{5mm}\Y_{i, t} = \begin{pmatrix}
            Y^{(i, 1)}_t \\
            Y^{(i, 2)}_t \\
            \vdots       \\
            Y^{\left(i, \abs{N_{\mathcal{A}}(i)} \right)}_t
        \end{pmatrix}
    \end{split}
\end{equation}

is a vector of traded quantities with the provider's neighbors. Expanding the provider's payoff,

\begin{equation}
    \begin{split}
        \Pi_i(p_{i, t}, \Y_{i, t}) &= p_{i, t} \cdot X_{i, t}(p_{i, t-1}) - \sum_{j \in N_{\mathcal{A}}(i)} Y_t^{(i, j)} \cdot P_t^{(i, j)} \\
        \text{ s.t. } X_{i, t}(p_{i, t-1}) &=  \sum_{j \in N_{\mathcal{A}}(i)} Y_t^{(i, j)}
    \end{split}
\end{equation}

The condition $X_{i, t}(p_{i, t-1}) =  \sum_{j \in N_{\mathcal{A}}(i)} Y_t^{(i, j)}$ requires the provider to always match (sell) the quantity demanded (supplied) in the local market by trading with its neighbors. For now, assume every pairwise price on the network, $P^{(i, j)}$, is determined only by the vector of traded quantities, $\Y$.

The provider's optimization is an intertemporal optimization problem that depends on the state $X_t$ which follows the evolution layed down in equation (\ref{x_true}). The provider is assumed to make two simplifying assumptions on this evolution. First, it perceived $M \cdot (\E[e_{t+1}] - e_{t})$ to be approximately $0$. This assumption is a good approximation in the case of a very persistent Markov chain $e_t$ (i.e. $\matr{\pi}_e \approx \matr{I}$). Second, not knowing each individual production state $s_{i, t}$ in the local market, it approximates the ramp-up function by a linear adaptive rule, proportional to the number of producers and the price, namely $R_t(p) \approx N \cdot( b + a\cdot p)$ with $b < 0$ and $a > 0$.

Given this setup we can specify the optimization problem of the provider. Suppressing $i$ for convenience (i.e. $Y^j \coloneqq Y^{(i, j)}$), the Bellman equation can be written as,

\begin{equation*}
    \begin{split}
        V(X_t) &= \max_{p_t, \Y_t} \left\{ p_t \cdot X_t - \sum_{j \in N_{\mathcal{A}}(i)} Y^j_t \cdot P^j(\Y_t) + \lambda_t \cdot \left( X_t - \sum_{j \in N_{\mathcal{A}}(i)} Y^j_t \right) + \beta \cdot  V(X_{t+1}) \right\} \\
        X_{t+1} &= X_t- N \cdot( b + a\cdot p_t)
    \end{split}
\end{equation*}

The optimization yields the policy function for local prices (\ref{a:provider_optimization}),

\begin{equation} \label{local_p}
    p_{t+1} = \lambda_{t+1} + \left( \frac{1 - \beta}{\beta} \right) \cdot \frac{X_t}{N \cdot a} - \frac{b +  a \cdot p_{t}}{a}
\end{equation}

\subsection{Bargaining model}

Given the evolution of the local price (\ref{local_p}), it is necessary to solve the bargaining model between providers (which determines the shadow price of acquiring outside electricity $\lambda_{t+1}$). To do so I first impose a ``direction'' of trade, namely a traded quantity $Y^{(i, j)}$ enters positively in $j$ and negatively in $i$, such that

\begin{equation}
    Y^{(i, j)} = -Y^{(j, i)}
\end{equation}

Furthermore we can rewrite the summation over the neighbors using $\matr{A}$, the adjacency matrix of the graph $\mathcal{A}$, with entries $a_{i, j}$, such that the instantaneous payoff of provider $i$ can be written as,

\begin{equation}
    \begin{split}
        \Pi_{i, t} &= X_{i, t} \cdot p_{i, t} - \sum_{j \in N_{\mathcal{A}}(i)} Y_t^{(i, j)} \cdot P_t^{(i, j)} \\
        &= X_{i, t} \cdot p_{i, t} - \sum_{j \in V} a_{i, j} \cdot Y_t^{(i, j)} \cdot P_t^{(i, j)}
    \end{split}
\end{equation}

I assume that the bargaining does not take into account individual market expectations and that it happens after the demand is already determined, such that $P$ is a function of $p$ only via $Y$. The Nash bargaining solution is such that,

\begin{equation}
    P_t^{(i, j)} = \arg \max_{P_t^{(i, j)}} \left\{\Pi_{i, t} \cdot \Pi_{j, t} \right\}.
\end{equation}


which yields, for every edge $(i, j)$ with $ a_{i, j} \neq 0$,

\begin{equation} \label{bargaining_solution}
    \begin{split}
        P_t^{(i, j)} = \frac{1}{2\cdot Y_t^{(i, j)}} \Biggl( &\underbrace{X_{i, t} \cdot p_{i, t} - X_{j, t} \cdot p_{j, t}}_{\text{revenue difference }}
        \\  + &\underbrace{\sum_{m\in N\setminus \set{i}} a_{j, m} \cdot Y_t^{(j, m)} \cdot P_t^{(j, m)}}_{\text{outside option of } j}
        \\ - & \underbrace{\sum_{m \in N\setminus \set{j}} a_{i, m} \cdot Y_t^{(i, m)} \cdot P_t^{(i, m)}}_{\text{outside option of } i} \Biggr).
    \end{split}
\end{equation}


In the bargaining problem we have a set of directed edges $E = \set{i \to j: i, j \in N}$. On each edge a bargaining price and a transferred quantity is determined. This defines the two vectors $P, \ Y \in \R^{\abs{E}}$. One can therefore simplify the solution by using the directed line graph associated with the original graph, with adjacency matrix $\matr{G} \in \R^{\abs{E}\times \abs{E}}$. First, let $\Delta_t$ in $\R^{\abs{E}}$ be the vector of revenue difference in the respective local markets with entries,

\begin{equation}
    \Delta^{(i, j)}_t \coloneqq X_{i, t} \cdot p_{i, t} - X_{j, t} \cdot p_{j, t}
\end{equation}

At each time $t$, equation (\ref{bargaining_solution}) can be then written as,

\begin{equation} \label{matrix_bargaining_solution}
    \begin{split}
        2(P \circ \Y) &= \Delta  - \matr{G} \left( P \circ \Y \right) \\
        (2\matr{I} + \matr{G}) (P \circ \Y) &= \Delta  \\
        (P \circ \Y) &= (2\matr{I} + \matr{G})^{-1} \Delta \\
        \diag(\Y) P &=  (2\matr{I} + \matr{G})^{-1} \Delta \\
        P &= \diag(\Y)^{-1} (2\matr{I} + \matr{G})^{-1} \Delta
    \end{split}
\end{equation}

where $\circ$ denotes the element-wise (Hadamard) product. To get a better intuition for this result, we can use the Neumann expansion of $(2\matr{I} + \matr{G})^{-1}$,

\begin{equation}
    P = \diag(\Y)^{-1} \sum^{\infty}_{k=0}\frac{(-1)^k}{2^{k+1}} \matr{G}^k \Delta
\end{equation}

Hence, the bargaining solution gives the price following price formation,

\begin{equation}
    P(\Y_t) = \diag(\Y_t)^{-1} (2\matr{I} + \matr{G})^{-1} \Delta
\end{equation}

with associated Jacobian (see \ref{a:jacobian_p}),

\begin{equation}
    \mathbb{J}\{P\}(\Y_t) = -\diag(\Y)^{-1} \diag(P)
\end{equation}

We can use this, combined with the local optimization $\lambda_t$, to obtain an explicit expression of the local optimization. The shadow price (\ref{lambda_before}) of the bargaining procedure is then,

\begin{equation}
    -\lambda_{i, t} = P^{(i, j)} + \sum_{k \in N \setminus \set{i}} a_{i, k} \cdot Y^{(i, k)} \cdot \mathbb{J}\{P\}^{(i, k)}_{(i, j)}
\end{equation}

Stacking the right hand side over edges,

\begin{equation}
    P + \mathbb{J}\{P\} \Y = 0 \ \implies \lambda_{i, t} = 0 \ \forall i
\end{equation}

This result yields the property that the surplus revenue $\Delta$ is allocated entirely based on the network structure,

\begin{equation}
    (2 \matr{I} + \matr{G})^{-1} = \sum^{\infty}_{k=0}\frac{(-1)^k}{2^{k+1}} \matr{G}^k
\end{equation}

\subsubsection{Belief update}

Providers approximate the ramp-up production function of the local producers using a linear rule,

\begin{equation}
    R_{t+1}(p_t) \approx b_t + a_t \cdot p_t
\end{equation}

I assume that each period providers observe the realization $R_{t+1}(p_t)$ and pick the coefficients $a_{t+1}$ and $b_{t+1}$ via ordinary least squares, more precisely

\begin{equation}
    \begin{pmatrix}
        b_{t+1} \\
        a_{t+1}
    \end{pmatrix} = (\matr{R}_{t+1}^T \matr{R}_{t+1})^{-1} (\matr{R}_{t+1}^T \matr{p}_t)
\end{equation}

where,
\begin{equation}
    \matr{R}_{t+1} = \begin{pmatrix}
        1      & R_{1}   \\
        1      & R_{2}   \\
        \vdots & \vdots  \\
        1      & R_{t+1}
    \end{pmatrix} \text{ and } \matr{p}_t = \begin{pmatrix}
        p_{0}  \\
        p_{1}  \\
        \vdots \\
        p_{t}
    \end{pmatrix}
\end{equation}

To recap the belief structure of the model,

\begin{table}[h!]
    \centering
    \input{sections/tables/perception.tex}
    \caption{Assumptions made by agents on other's processes}
    \label{table:perception}
\end{table}