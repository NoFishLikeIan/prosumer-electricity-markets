\documentclass{beamer}

\setlength{\unitlength}{1cm} 
\usetheme{Frankfurt}
\useoutertheme{infolines}


\usepackage[english]{babel}
\usepackage[utf8]{inputenc}

\usepackage{amsmath, amssymb, mathtools, bbm}
\usepackage{bm}

\usepackage{graphicx}
\usepackage{wrapfig}
\usepackage{tikz} 
\usepackage{relsize}
\usepackage{makecell}
\usepackage{booktabs}
\usepackage{subcaption}
\usepackage{float}
\usepackage{multirow} 

\usepackage[style=apa]{biblatex}
\usepackage{csquotes}

\bibliography{
    ../../../../Desktop/bibliographies/thesis,
    ../maths}


% Graphs
\usetikzlibrary{positioning, arrows.meta, calc, decorations.markings, math, matrix, fit, backgrounds}

\tikzset{fontscale/.style = {font=\relscale{#1}}}

\definecolor{prosumer}{cmyk}{0,0.816,0.408,0}

% Math commands
\newcommand{\E}{\mathbb{E}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\B}{\mathbb{B}}

\newcommand{\matr}[1]{\bm{#1}}
\newcommand{\set}[1]{\left\{#1\right\}}

\newcommand{\Y}{\matr{Y}}
\newcommand{\I}{\matr{I}}
\newcommand{\G}{\matr{G}}
\newcommand{\T}{\matr{T}}

\newcommand{\V}{\mathbb{V}}

% PATHS

\newcommand{\outdiag}{../thesis/sections/diagrams}


\title{How directed is a directed network?}
\author{Andrea Titton}
\title{Thesis defence}
\subtitle{Contagion of Electricity Prices \\ A Dynamic Game of Price Hikes Propagation}
\institute{Tinbergen Institute}
\date{04/12/2020}

\begin{document}

\AtBeginSubsection[]
{
    \begin{frame}
        \frametitle{Table of Contents}
        \tableofcontents[currentsection,currentsubsection]
    \end{frame}
}

\frame{\titlepage}

\begin{frame}
    \tableofcontents
\end{frame}

\section{Introduction}

\begin{frame}{Motivation}
    Green energy transition and advent of \textbf{prosumers}
    \vspace{2em}
    \begin{itemize} \setlength\itemsep{1.5em}
              \pause \item Risk of \textit{local} demand shocks
              \pause \item \textbf{Local quasi-monopolies} energy providers (e.g. ERCOT case in Texas) and decentralized prosumers
              \pause \item Weather shocks lead to \textbf{uncertainty} among risk averse consumers
    \end{itemize}
\end{frame}

\begin{frame}{Lack of price convergence}
    \begin{figure}
        \includegraphics[height = 0.7\textheight]{figures/convergence.PNG}
        \caption{\cite{Report2019}}
    \end{figure}
\end{frame}

\begin{frame}{Research question}

    Prosumers induce three sources of uncertainty: bounded rationality, risk aversion, and renewable energy volatility

    \begin{itemize} \setlength{\itemsep}{1em}
        \item \textit{How do exogenous and unexpected demand shocks affect the price formation mechanism?} \pause
        \item \textit{How do shock in prices transmit to the cross-border market?} \pause
        \item \textit{Hysteresis: can this shock produce sustained price imbalances?} \pause
        \item \textit{Are current policies effective in this framework?}
    \end{itemize}

\end{frame}

\begin{frame}{What is new?}

    Comparison with previous ABM (\cite{Weidlich2008})
    \vfill

    \visible<1->{\begin{minipage}{0.4\textwidth}
            \resizebox{\textwidth}{!}{\input{diagrams/previous.tikz}}
        \end{minipage}}
    \hfill
    \visible<2->{\begin{minipage}{0.55\textwidth}
            \resizebox{\textwidth}{!}{\input{diagrams/question.tikz}}
        \end{minipage}}
\end{frame}

\section{Model}

\begin{frame}{Notation: beliefs $\B$}
    \begin{itemize} \setlength\itemsep{1.5em}
        \item Agents have beliefs over processes $x_t$, denoted by $\B[x_{t+1}]$
        \item These can be dependent on the information available to agents up to time $t$, denoted $\B_t[\cdot]$
    \end{itemize}
\end{frame}

\begin{frame}{Notation: graphs}
    \begin{itemize} \setlength\itemsep{1.5em}
        \item A graph $\mathcal{A}$ is a set of $V$ vertex and $E$, with adjacency matrix $\matr{A}$ \pause
        \item $L(\mathcal{A}) = (V_L, E_L)$ is the associated \textbf{line graph}, with adjacency matrix $\matr{G}$ \pause
        \item $V_L \subseteq V$ and $E_L \subseteq E$ \pause
    \end{itemize}
    \begin{center}
        \resizebox{!}{0.4\textheight}{\input{diagrams/linegraphex.tikz}}
    \end{center}
\end{frame}


\begin{frame}{Model outline}
    \centering
    \only<1>{
        \resizebox{\textwidth}{!}{\input{diagrams/timing.tikz}}}
    \only<2>{
        \resizebox{\textwidth}{!}{\input{diagrams/focusonlocal.tikz}}}
\end{frame}

\subsection{Local market}

\begin{frame}{Prosumers}
    \begin{itemize} \setlength\itemsep{1.5em}
        \item M producer pre local market \pause
        \item All with the same ``demand endowment'' $e_t$
    \end{itemize}
\end{frame}

\begin{frame}{Producers setup}
    Main modelling assumption \vspace{5mm}
    \begin{itemize} \setlength\itemsep{1.5em}
        \item Price takers $p_t$ and oligopolist \pause
        \item Produce electricity $s_t$ at fixed marginal cost $k$ \pause
        \item Can ramp-up or down production with a one period delay by $r_t \in [\underline{r}, \overline{r}]$ \pause
        \item $r_t$ costs $c(s_t, r_t) = \max \{0, s_t \ r_t \}$ per unit
    \end{itemize}
\end{frame}


\begin{frame}{Producers optimization}
    \begin{equation*}
        V(s_t, p_t) = \max_{r_t} \left\{ s_t \ \underbrace{(p_t - k)}_{\text{unit profit}} - \underbrace{ c(s_t, r_t) \  r_t }_{\text{ramp-up costs}} + \beta \  V(s_{t+1}, p_{t+1}) \right\}
    \end{equation*}
    \vspace{5mm}
    \visible<2>{\begin{itemize} \setlength\itemsep{1.5em}
            \item $s_{t+1} = s_t + r_t$
            \item Providers are naive: $\B[p_{t+1}] = p_t$
        \end{itemize}}
\end{frame}

\begin{frame}{Marginal costs and benefits}

    The policy function $r(p_t, s_t)$ is such that $mc(r) = mb(r)$.

    \visible<2->{
        \begin{equation*}
            mc = \overbrace{c(s_t, r)}^{\text{cost you pay today}} + \overbrace{r \ \frac{\partial c}{\partial r}(s_t, r)}^{\text{moved to new cost level}}
        \end{equation*}
    }

    \visible<3->{
        \begin{equation*}
            \begin{split}
                \frac{mb}{\beta} &= \overbrace{(p_t - k)}^{\text{unit profit}} + \overbrace{\left(\frac{\partial c}{\partial r}(s_t + r, r) - \frac{\partial c}{\partial s_t}(s_t + r, r)\right)}^{\text{moved to a new level of costs tomorrow}} \ r + \\
                & + \underbrace{c(s_t + r, r)}_{\text{costs you do not pay tomorrow}}
            \end{split}
        \end{equation*}
    }

\end{frame}

\begin{frame}{Policy $r$}
    \visible<1->{
        If equality is possible
        \begin{equation*} \label{rpolicy}
            r(s_t, p_t) =
            \frac{1 - \beta}{\beta} \ s_t - \sqrt{ \left(\frac{1 - \beta}{\beta} \ s_t \right)^2 - \ \left(p_t - k\right) }.
        \end{equation*}

        \begin{itemize}
            \item $r(s_t, p_t) \xrightarrow{} 0$ as $p_t \xrightarrow{} k$
            \item Decreasing in $s_t$ and increasing in $p_t$
        \end{itemize}
    }

    \vfill

    \visible<2->{
        There are two \textit{regions} where equality is not possible:
        \begin{itemize}
            \item If $p_t \leq k$ there are no unit profits, $mc(r) > mb(r)$
            \item If $s_t \leq \frac{\beta}{1-\beta} \sqrt{p_t - k}$ production is too low, $mc(r) < mb(r)$
        \end{itemize}
    }
\end{frame}


\begin{frame}
    \begin{figure}
        \includegraphics[width = 0.8 \textwidth]{../../plots/rfunction.pdf}
    \end{figure}
\end{frame}

\begin{frame}{Demand}
    Let $R_t = \sum^N_{i = 1} r_t$, \\
    then the \textbf{excess demand} in the local market changes as,

    \vspace{0.2\textheight}

    \begin{equation*}
        X_{t+1} - X_t = \underbrace{M \left(e_{t+1} - e_t \right)}_{\text{Increases in demand shocks}} - \underbrace{R_t}_{\text{Decreases in ramp-up}}
    \end{equation*}
\end{frame}

\begin{frame}{Provider local problem}
    \visible<1->{
        The provider $i$ needs to,

        \begin{enumerate}
            \item Pick $p_{t}$ which induces $X_{i, t}$
            \item Trade with its neighbors $N_{\mathcal{A}}(i)$ the quantities $Y^{(i, j)}$ so that $X_{i, t} \leq \sum_j Y^{(i, j)}$
        \end{enumerate}
    }

    \visible<2->{
        \begin{equation*}
            \begin{split}
                V(X_{i, t}, S_{i, t}) = \max_{p_{i, t}, Y^{(i, j)}_t} \Bigg\{ &\overbrace{p_{i, t} \  X_{i, t} - \sum_{j \in N_{\mathcal{A}}(i)} Y^{(i, j)}_t \  P^{(i, j)}(\Y_t)}^{\text{Instantaneous profits}} \\
                &+ \underbrace{\lambda_{i, t} \  \left( X_{i, t} - \sum_{j \in N_{\mathcal{A}}(i)} Y^{(i, j)}_t \right)}_{\text{Constraint}} \\
                &+ \beta \   V(X_{i, t+1}, S_{i, t+1}) \Bigg\}
            \end{split}
        \end{equation*}
    }


\end{frame}


\begin{frame}{Provider's beliefs}

    There are two state variables $X_{i, t}$ and $S_{i, t}$,

    \begin{equation*}
        \begin{split}
            X_{i, t+1} &= X_{i, t} - \B_{i, t} \left[R(p_{i, t}, S_{i, t}) \right] \\
            S_{i, t+1} &= S_{i, t} + \B_{i, t} \left[R(p_{i, t}, S_{i, t}) \right]
        \end{split}
    \end{equation*}

    where,

    \begin{minipage}{.45\textwidth}
        \begin{equation*}
            \begin{split}
                &\B_{i, t} \left[R(p_{i, t}, S_{i, t}) \right] = \\
                &\alpha_{i, t} + \gamma_{i, t} \  p_{i, t} + \eta_{i, t} \ S_{i, t}
            \end{split}
        \end{equation*}
    \end{minipage}
    \hfill
    \begin{minipage}{.45\textwidth}
        \begin{figure}
            \includegraphics[height = 0.4\textheight]{../../plots/constant/star/ols.pdf}
        \end{figure}
    \end{minipage}

\end{frame}

\begin{frame}

    The optimization problem determines the \textbf{local price evolution}
    \begin{equation*}
        p_{i, t+1} = p_{i, t} + \underbrace{\frac{1}{\gamma_{i, t}} \left( \frac{1-\beta}{\beta } X_{i, t} + \alpha_{i, t} + \eta_{i, t} S_{i, t} \right)}_{\text{influence of local market } L_{i, t}(X_{i, t}, S_{i, t})} - \underbrace{\lambda_{i, t}}_{\text{influence of cross-border market}}
    \end{equation*}

\end{frame}

\subsection{Cross-border market}

% CB market
\begin{frame}{Cross-border market}
    \centering
    \resizebox{\textwidth}{!}{\input{diagrams/overview.tikz}}
\end{frame}

\begin{frame}[allowframebreaks]{Nash-bargaining}
    Conditional on $\matr{X}_t$ and $\matr{p}_t$ being determined,

    \begin{equation*}
        \begin{split}
            P_t^{(i, j)} &= \arg \max_{P_t^{(i, j)}} \left\{\Pi_{i, t} \  \Pi_{j, t} \right\} \\
            &= \frac{1}{2\  Y_t^{(i, j)}} \times \\
            &\times \left( \underbrace{\Delta^{(i, j)}_t}_{\text{revenue difference }}
            + \underbrace{\sum_{m\in N_{\mathcal{A}}(j)} Y_t^{(j, m)} \  P_t^{(j, m)}}_{\text{outside option of } j}
            - \underbrace{\sum_{m \in N_{\mathcal{A}}(i)} Y_t^{(i, m)} \  P_t^{(i, m)}}_{\text{outside option of } i} \right)
        \end{split}
    \end{equation*}
    \newpage
    Stacking in vectors,

    \begin{equation*}
        \begin{split}
            2(P_t \circ \Y_t) &= \Delta_t  - \G \left( P_t \circ \Y_t \right) \\
            (2\I + \G) (P_t \circ \Y_t) &= \Delta_t  \\
            (P_t \circ \Y_t) &= (2\I + \G)^{-1} \Delta_t \\
            P(\Y_t) &= \left((2\I + \G)^{-1} \Delta_t \right) \oslash \Y_t
        \end{split}
    \end{equation*}
\end{frame}

\begin{frame}{Back to the first order condition}
    The optimization problem for a neighboring quantity $Y^{(i, m)}$ (suppressing $i$) we obtain,

    \begin{equation*}
        \begin{split}
            -\lambda_t &= \sum_{j \in N_{\mathcal{A}}(i)} \frac{\partial (Y_t^j \  P_t^j(\Y_t))}{\partial Y_t^m} \\
            &= P_t^m(\Y_t) + \sum_{j \in N_{\mathcal{A}}(i) \setminus \set{m}} Y_t^j \  \frac{\partial P_t^j(\Y_t)}{\partial Y_t^m}
        \end{split}
    \end{equation*}
    Using the price just derived we can write $-\lambda_t = 2 P_t^m(\Y_t) $.

\end{frame}

\begin{frame}{Recap}
    \renewcommand{\arraystretch}{3}
    \resizebox{\linewidth}{!}{
        \begin{tabular}{c  c | c }
            Agent            & Actual process                                                                                               & Perceived process                                                                 \\
            \midrule
            \boxed{Provider} & $R_t = \sum^N_{i = 1} r(s_{i, t}, p_t)$                                                                      & $ \B_{t} \left[R_{t+1} \right] = \alpha_{t} + \gamma_{t} \  p_t + \eta_{t} \ S_t$ \\
                             & $M \  \left(e_{t+1} - e_t \right)$                                                                           & $\B\left[ M \  \left(e_{t+1} - e_t \right)\right] = 0$                            \\
            \midrule
            \boxed{Producer} & $p_{t+1} = p_t + \frac{1-\beta}{\beta \ \gamma} X_t + \frac{\alpha + \eta S_t}{\gamma} + 2P^m(\matr{Y}_{t})$ & $\B\left[p_{t+1}\right] = p_t$
        \end{tabular}
    }
\end{frame}

\section{Contagion}

\begin{frame}{Bargaining influence matrix}

    Contagion is determined, via $P(\Y_t)$, by

    \begin{equation*}
        (2\I + \G)^{-1}
    \end{equation*}

    called here \textit{bargaining influence matrix}

\end{frame}

\iffalse
    \begin{frame}{Two}

        \visible<1->{
            Consider the simplest case, two providers, \resizebox{0.4\textwidth}{!}{\input{diagrams/two.tikz}}}

        \visible<2->{
            \begin{equation*}
                \G = \begin{pmatrix}
                    0
                \end{pmatrix}
            \end{equation*}
        }

        \visible<3->{
            \begin{equation*}
                (2\I + \G)^{-1} = 1 / 2
            \end{equation*}
            $\implies$ bargaining power is equally divided
        }

    \end{frame}
\fi


\begin{frame}[allowframebreaks]{Star}

    If $\mathcal{A}$ (\textit{left}) is a star graph then $L(\mathcal{A})$ (\textit{right}) is a complete graph. \vspace{5mm}

    \begin{columns}[T,onlytextwidth]

        \begin{column}{.46\textwidth}
            \resizebox{\linewidth}{!}{\input{\outdiag/star.tikz}}
        \end{column}

        \hfill

        \begin{column}{.46\textwidth}
            \resizebox{\linewidth}{!}{\input{diagrams/assocstar.tikz}}
        \end{column}
    \end{columns}

    then

    \begin{equation*}
        (2\I + \G)^{-1} =
    \end{equation*}

    \begin{columns}
        \begin{column}{.46\textwidth}
            \begin{figure}
                \includegraphics[width = \linewidth]{../../plots/bargmatrices/star.png}
            \end{figure}
        \end{column}

        \hfill

        \begin{column}{.46\textwidth}
            \begin{figure}
                \includegraphics[width = \linewidth]{../../plots/bargmatrices/path.png}
            \end{figure}
        \end{column}
    \end{columns}


\end{frame}



\iffalse
    \section{Policy}

    \section{Conclusion}
\fi




\begin{frame}[allowframebreaks]{Bibliography}
    \printbibliography
\end{frame}

\end{document}